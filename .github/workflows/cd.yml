name: CD

on:
  push:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  GCP_PROJECT_ID: homework-coach-robo
  GCP_REGION: asia-northeast1
  ARTIFACT_REGISTRY: asia-northeast1-docker.pkg.dev/homework-coach-robo/homework-coach-docker

jobs:
  ci-backend:
    name: CI Backend
    uses: ./.github/workflows/ci-backend.yml

  ci-frontend:
    name: CI Frontend
    uses: ./.github/workflows/ci-frontend.yml

  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    needs: ci-backend
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build Docker image
        run: |
          docker build \
            --platform linux/amd64 \
            -f infrastructure/docker/backend/Dockerfile \
            -t ${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/backend:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/backend:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy homework-coach-backend \
            --image=${{ env.ARTIFACT_REGISTRY }}/backend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --allow-unauthenticated \
            --quiet

  deploy-agent-engine:
    name: Deploy Agent Engine Artifacts
    runs-on: ubuntu-latest
    needs: ci-backend
    timeout-minutes: 20
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴取得（git diffに必要）

      - name: Check backend changes
        id: backend_changes
        run: |
          if [ -z "${{ github.event.before }}" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "⚠ No previous commit (initial push), assuming backend changed"
          elif git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep -q '^backend/'; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "✓ Backend changes detected"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "✓ No backend changes, skipping Agent Engine deployment"
          fi

      - name: Set up Python
        if: steps.backend_changes.outputs.changed == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        if: steps.backend_changes.outputs.changed == 'true'
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install backend dependencies
        if: steps.backend_changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          uv sync

      - name: Serialize Agent
        if: steps.backend_changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          echo "Serializing Router Agent..."
          uv run python scripts/serialize_agent.py
          if [ ! -f pickle.pkl ]; then
            echo "✗ Error: pickle.pkl not generated"
            exit 1
          fi
          echo "✓ Serialized successfully ($(stat -c%s pickle.pkl) bytes)"

      - name: Package dependencies
        if: steps.backend_changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          echo "Packaging dependencies..."
          tar -czf dependencies.tar.gz app/
          if [ ! -f dependencies.tar.gz ]; then
            echo "✗ Error: dependencies.tar.gz not generated"
            exit 1
          fi
          echo "✓ Packaged successfully ($(stat -c%s dependencies.tar.gz) bytes)"

      - name: Authenticate to Google Cloud
        if: steps.backend_changes.outputs.changed == 'true'
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        if: steps.backend_changes.outputs.changed == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload artifacts to GCS
        if: steps.backend_changes.outputs.changed == 'true'
        working-directory: backend
        run: |
          BUCKET_NAME="${{ secrets.GCS_ASSETS_BUCKET }}"

          if [ -z "$BUCKET_NAME" ]; then
            echo "✗ Error: GCS_ASSETS_BUCKET secret is not set"
            echo "  Set it to the Terraform output value of module.cloud_storage.bucket_name"
            exit 1
          fi

          echo "Using bucket: $BUCKET_NAME"
          echo "Uploading artifacts..."

          gcloud storage cp pickle.pkl "gs://${BUCKET_NAME}/agent-engine/" || exit 1
          gcloud storage cp agent_engine_requirements.txt "gs://${BUCKET_NAME}/agent-engine/requirements.txt" || exit 1
          gcloud storage cp dependencies.tar.gz "gs://${BUCKET_NAME}/agent-engine/" || exit 1

          echo "✓ All artifacts uploaded successfully"
          echo "  - gs://${BUCKET_NAME}/agent-engine/pickle.pkl"
          echo "  - gs://${BUCKET_NAME}/agent-engine/requirements.txt"
          echo "  - gs://${BUCKET_NAME}/agent-engine/dependencies.tar.gz"

      - name: Update Agent Engine
        if: steps.backend_changes.outputs.changed == 'true'
        working-directory: backend
        env:
          AGENT_ENGINE_RESOURCE_NAME: ${{ secrets.AGENT_ENGINE_RESOURCE_NAME }}
        run: |
          if [ -z "$AGENT_ENGINE_RESOURCE_NAME" ]; then
            echo "::warning::AGENT_ENGINE_RESOURCE_NAME not set. Skipping Agent Engine update."
            echo "  First deploy: uv run python scripts/deploy_agent_engine.py --project ... --bucket ..."
            echo "  Then set AGENT_ENGINE_RESOURCE_NAME GitHub Secret"
            exit 0
          fi

          echo "Updating Agent Engine: $AGENT_ENGINE_RESOURCE_NAME"
          uv run python scripts/deploy_agent_engine.py \
            --project "${{ env.GCP_PROJECT_ID }}" \
            --location us-central1 \
            --bucket "${{ secrets.GCS_ASSETS_BUCKET }}" \
            --resource-name "$AGENT_ENGINE_RESOURCE_NAME"

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [ci-frontend, deploy-backend, deploy-agent-engine]
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Get Backend URL
        id: backend-url
        run: |
          BACKEND_URL=$(gcloud run services describe homework-coach-backend \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "url=$BACKEND_URL" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            --platform linux/amd64 \
            -f infrastructure/docker/frontend/Dockerfile \
            --build-arg NEXT_PUBLIC_API_URL=${{ steps.backend-url.outputs.url }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }} \
            -t ${{ env.ARTIFACT_REGISTRY }}/frontend:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }}
          docker push ${{ env.ARTIFACT_REGISTRY }}/frontend:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy homework-coach-frontend \
            --image=${{ env.ARTIFACT_REGISTRY }}/frontend:${{ github.sha }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --allow-unauthenticated \
            --quiet
