---
name: analyze-errors
description: Delegates error analysis and fix generation to a sub-agent. Use when quality checks fail with multiple errors, runtime errors occur, or you need bulk error categorization and fix proposals. Accepts error output or runs checks to collect errors.
allowed-tools: Task
---

# Analyze Errors

## Overview

このスキルは、エラー分析と修正案の生成をサブエージェントに委譲します。品質チェックで多数のエラーが出た場合や、ランタイムエラーの原因調査に使います。

## When to Use

- `/quality-check` で FAIL が返ったとき（特にエラー数が多い場合）
- テスト実行時に複数のテストが失敗したとき
- ランタイムエラーやスタックトレースの原因を調査するとき
- 大量のエラーを一括で分類・修正したいとき

## Instructions

### Step 1: エラーの種類を判定

| エラーの種類 | サブエージェントタイプ | 説明 |
|-------------|-------------------|------|
| mypy / TypeScript 型エラー | `general-purpose` | コード読み込み + 型解析が必要 |
| ruff / Biome lint エラー | `Bash` | 自動修正コマンドで解決可能な場合が多い |
| pytest / Vitest テスト失敗 | `general-purpose` | テストコード + 実装コードの読み込みが必要 |
| ランタイムエラー / スタックトレース | `general-purpose` | コード探索 + 原因特定が必要 |
| Terraform エラー | `general-purpose` | HCL構文 + プロバイダ設定の確認が必要 |

### Step 2: サブエージェントを起動

対象に応じて Task ツールでサブエージェントを起動してください。

---

#### 型エラー分析用プロンプト（mypy / TypeScript）

```
以下の型エラーを分析し、修正案を生成してください。

作業ディレクトリ: [ディレクトリの絶対パス]

## エラー情報
[エラー出力をここに貼り付け、または以下のコマンドで取得]
コマンド: cd [ディレクトリ] && uv run mypy .
（またはフロントエンドの場合: cd [ディレクトリ] && bun typecheck）

## 分析手順

### 1. エラーの分類
エラーを以下のカテゴリに分類:
- エラーコード別（no-untyped-def, union-attr, arg-type 等）
- ファイル別（どのファイルにエラーが集中しているか）

### 2. 修正案の生成
カテゴリごとに:
- 修正パターンの説明（例: `-> None` を追加、`assert is not None` ガード追加）
- 影響範囲（何ファイル、何行に適用が必要か）
- `# type: ignore` が適切なケース（サードパーティライブラリの型定義不足等）

### 3. 修正の優先順位
- 自動修正可能なもの（パターンが統一的）を先に
- 個別判断が必要なものを後に

## 報告フォーマット

### エラーサマリー
- 合計: X errors
- カテゴリ別内訳テーブル

### 修正計画
各カテゴリについて:
1. 修正パターン
2. 対象ファイル一覧
3. 推奨アプローチ（一括修正 / 個別修正）
```

---

#### テスト失敗分析用プロンプト（pytest / Vitest）

```
以下のテスト失敗を分析し、原因と修正案を特定してください。

作業ディレクトリ: [ディレクトリの絶対パス]

## エラー情報
[テスト出力をここに貼り付け、または以下のコマンドで取得]
コマンド: cd [ディレクトリ] && uv run pytest tests/ -v --tb=short
（またはフロントエンドの場合: cd [ディレクトリ] && bun test）

## 分析手順

### 1. 失敗テストの特定
各失敗テストについて:
- テスト名とファイルパス
- エラーメッセージ
- 期待値 vs 実際の値

### 2. 原因の特定
各失敗について:
- テストコードを読み込んで期待動作を理解
- 対応する実装コードを読み込んで実際の動作を確認
- 原因を特定（実装バグ / テストの期待値ミス / 環境依存 / モック不足）

### 3. 修正案の生成
- テストを修正すべきか、実装を修正すべきか判断
- 具体的な修正コードを提示

## 報告フォーマット

### 失敗テストサマリー
- 合計: X failed, Y passed

### 各失敗テストの分析
テストごとに:
1. テスト名: `test_xxx`
2. ファイル: `path/to/test.py:line`
3. 原因: [説明]
4. 修正案: [コード]
5. 修正対象: テスト / 実装
```

---

#### ランタイムエラー分析用プロンプト

```
以下のランタイムエラーを分析し、原因と修正案を特定してください。

作業ディレクトリ: [ディレクトリの絶対パス]

## エラー情報
[スタックトレースやエラーログをここに貼り付け]

## 分析手順

### 1. スタックトレースの解析
- エラーの発生箇所（ファイル、行番号、関数名）を特定
- コールチェーンをたどり、根本原因の箇所を特定

### 2. 関連コードの読み込み
- エラー発生箇所のコードを読み込み
- 呼び出し元のコードも読み込み
- 関連するモデル/スキーマ定義も確認

### 3. 原因と修正案
- 根本原因の説明
- 修正コードの提示
- 再発防止策（テスト追加等）

## 報告フォーマット

### エラー概要
- エラー種別: [TypeError / ValueError / etc.]
- 発生箇所: [ファイル:行番号]
- 根本原因: [説明]

### 修正案
1. [具体的な修正コード]
2. [追加すべきテスト]
```

---

### Step 3: 修正の実行

サブエージェントの分析結果に基づいて：

- **自動修正可能なエラー**: 別のサブエージェントに一括修正を委譲（ファイル数が多い場合は並列で）
- **個別判断が必要なエラー**: メインエージェントで対応
- **修正後**: `/quality-check` で再確認

## Notes

- エラー数が10件以上の場合、このスキルの効果が特に大きい
- 前回の mypy 264 errors の修正では、12並列サブエージェントで一括修正した実績あり
- エラー分析と修正を別のサブエージェントに分けることで、分析結果を見てから修正方針を決められる
