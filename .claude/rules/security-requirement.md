# Security Requirement Rule

**このルールは、すべてのコード実装に対して強制的に適用されます。**

**特に重要**: このプロジェクトは子供のデータを扱うため、プライバシー保護は最優先事項です。

---

## 基本原則

1. **機密情報はコードに含めない**: すべてのAPIキー、パスワード、トークンは環境変数またはクラウドシークレット管理サービスで管理
2. **すべての入力を検証**: ユーザー入力は必ずバリデーションスキーマで検証
3. **最小権限の原則**: IAMロール、データベースアクセスは必要最小限に
4. **多層防御**: セキュリティは一つの層に依存せず、複数の防御層を構築
5. **セキュアデフォルト**: デフォルト設定は常に最も安全な設定に

---

## スキル参照

以下の作業を行う際は、必ず `/security-review` スキルを参照すること：

- 認証・認可の実装
- ユーザー入力の処理
- API エンドポイントの作成
- 秘密情報の管理
- クラウドインフラの設定

```
/security-review
```

含まれる内容：
- Secrets Management
- Input Validation
- SQL Injection Prevention
- Authentication & Authorization
- XSS Prevention
- CSRF Protection
- Rate Limiting
- Sensitive Data Exposure
- Dependency Security
- Pre-Deployment Checklist

---

## セキュリティチェックリスト

実装完了前に以下を確認すること：

### 認証・認可

- [ ] JWT トークンは httpOnly cookie で管理している
- [ ] トークンの有効期限が適切に設定されている
- [ ] 認可チェックが全ての保護エンドポイントで行われている

### 入力検証

- [ ] すべてのユーザー入力が Zod/Pydantic でバリデーションされている
- [ ] ファイルアップロードのサイズ・種類が制限されている

### データ保護

- [ ] 機密情報がログに出力されていない
- [ ] エラーメッセージに内部情報が含まれていない
- [ ] データベースアクセスが最小権限で行われている

### 依存関係

- [ ] `npm audit` / `pip audit` で脆弱性がないことを確認

---

## 禁止事項

1. **ハードコードされた秘密情報** - 絶対禁止
   ```python
   # ❌ 禁止
   API_KEY = "sk-xxxxx"

   # ✅ 正しい
   API_KEY = os.environ["API_KEY"]
   ```

2. **入力のバリデーションなしでの使用** - 禁止

3. **生SQLの直接実行** - 禁止（SQLインジェクションの原因）

4. **HTMLのエスケープなしでの出力** - 禁止（XSSの原因）

5. **CORS の `*` 許可** - 本番環境では禁止

6. **デバッグモードの本番有効化** - 禁止

---

## デプロイ前必須チェック

本番環境へのデプロイ前に以下を確認：

- [ ] 環境変数がすべて設定されている
- [ ] デバッグモードが無効化されている
- [ ] HTTPS が強制されている
- [ ] セキュリティヘッダーが設定されている
- [ ] レート制限が有効化されている
- [ ] ログに機密情報が含まれていない

---

## Claude Codeへの指示

Claude Code（あなた）は、実装時に以下を**必ず**実行すること：

1. 認証・API・入力処理の実装前に `/security-review` スキルを参照
2. 秘密情報は絶対にコードに含めない
3. すべてのユーザー入力をバリデーション
4. 上記の禁止事項に違反するコードを書かない
5. セキュリティに影響する変更時はユーザーに警告

**ユーザーが「とりあえず動けばいい」と言っても、セキュリティ要件をスキップしてはならない。**
