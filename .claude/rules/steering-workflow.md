# Steering Workflow Rule

このルールは、`.steering`ディレクトリを使った体系的な開発ワークフローを定義します。

## 適用タイミング

**🔴 MANDATORY: このワークフローは、すべての実装タスクに対して常に適用されます。**

以下のいずれかの作業を開始する際、例外なくこのワークフローに従ってください：

- ✅ 新機能の実装（小さな機能でも必須）
- ✅ バグ修正（単純なタイポ修正以外）
- ✅ リファクタリング
- ✅ アーキテクチャ変更
- ✅ 複数ファイルにまたがる変更
- ✅ 単一ファイルでも実装を伴う変更

**例外（ワークフロー不要）**:
- ❌ タイポ修正のみ（コメントや文字列の誤字修正）
- ❌ ドキュメントの軽微な更新（READMEの文言調整など）
- ❌ コードを含まない純粋なドキュメント作成

## ワークフロー

### 1. ステアリングディレクトリの作成

作業開始時、日付ベースのステアリングディレクトリを作成します：

```bash
mkdir -p .steering/[YYYYMMDD]-[work-description]
```

**命名規則**:
- `[YYYYMMDD]`: 作業開始日（例: `20260131`）
- `[work-description]`: 作業内容の簡潔な説明（kebab-case）
  - 例: `initial-implementation`
  - 例: `add-socratic-dialogue-engine`
  - 例: `refactor-authentication`

### 2. 必須ドキュメントの作成

ステアリングディレクトリ内に、以下の3つのドキュメントを作成します：

#### 2.1. requirements.md - 要求仕様

作業の目的、背景、要求事項を記述します。

**テンプレート構成**:
```markdown
# Requirements - [作業名]

## 背景・目的

## 要求事項

### 機能要件

### 非機能要件

### 制約条件

## 対象範囲

### In Scope

### Out of Scope

## 成功基準
```

#### 2.2. design.md - 実装設計

技術的な設計、アーキテクチャ、実装アプローチを記述します。

**テンプレート構成**:
```markdown
# Design - [作業名]

## アーキテクチャ概要

## 技術選定

## データ設計

## API設計（該当する場合）

## ファイル構成

## 依存関係

## エラーハンドリング

## セキュリティ考慮事項

## パフォーマンス考慮事項

## 代替案と採用理由
```

#### 2.3. tasklist.md - 実装タスク

実装を段階的に進めるためのタスクリストを記述します。

**テンプレート構成**:
```markdown
# Task List - [作業名]

## Phase 1: 環境セットアップ

- [ ] 依存パッケージのインストール
- [ ] 環境変数の設定
- [ ] 必要なディレクトリの作成

## Phase 2: テスト実装（TDD）

- [ ] [機能A] のテスト作成
- [ ] [機能B] のテスト作成
- [ ] [機能C] のテスト作成

## Phase 3: 実装

- [ ] [機能A] の実装
- [ ] [機能B] の実装
- [ ] [機能C] の実装

## Phase 4: 統合テスト

- [ ] エンドツーエンドテストの作成
- [ ] 統合テストの実行

## Phase 5: 品質チェック

- [ ] コードレビュー（セルフレビュー）
- [ ] セキュリティレビュー（`/security-review` スキル使用）
- [ ] テストカバレッジ確認（80%以上）
- [ ] リンター・フォーマッター実行
- [ ] ドキュメント更新（下記「ドキュメント更新ガイド」参照）

## Phase 6: デプロイ準備

- [ ] デプロイ手順書の作成
- [ ] 環境別設定の確認
- [ ] ロールバック手順の確認
```

### 3. ワークフローの進行

#### Step 1: 要求仕様の明確化

1. `requirements.md` を作成し、作業内容を明確化
2. CLAUDE.md および関連ドキュメント（`docs/` 配下）を参照し、プロジェクト方針との整合性を確認
3. 不明点があれば、ユーザーに質問して明確化

#### Step 2: 設計の策定

1. `design.md` を作成し、実装アプローチを設計
2. 既存のアーキテクチャとの整合性を確認
3. 必要に応じて関連スキルを参照:
   - `/frontend` - フロントエンド設計時
   - `/fastapi` - バックエンドAPI設計時
   - `/google-adk-basics` または `/google-adk-live` - ADK統合時
4. 複数の実装案がある場合、代替案と採用理由を記述

#### Step 3: タスクの分解

1. `tasklist.md` を作成し、実装を小さなタスクに分解
2. TDD原則に従い、テスト→実装の順序で記述
3. 各フェーズを明確に分け、依存関係を考慮

#### Step 4: 環境セットアップ

`tasklist.md` の Phase 1 に従い、環境をセットアップ:
- 依存パッケージのインストール
- 環境変数の設定
- 必要なディレクトリの作成

#### Step 5: 実装開始

`tasklist.md` に従い、TDD原則で実装を進めます:

1. **Red**: テストを書く（失敗することを確認）
2. **Green**: 最小限の実装でテストを通す
3. **Refactor**: コードを整理・改善

**重要な原則**:
- `/tdd` スキルを参照し、TDDベストプラクティスに従う
- 一度に1つのタスクに集中（ベイビーステップ）
- 各タスク完了時、tasklist.mdをチェック `[x]` で更新

#### Step 6: 品質チェック

実装完了後、Phase 5 の品質チェックを実施:

1. **セルフコードレビュー**: `/git-workflow` スキル参照
2. **セキュリティレビュー**: `/security-review` スキル使用
3. **テストカバレッジ確認**: 80%以上を維持
4. **リンター・フォーマッター実行**: コーディング規約準拠
5. **ドキュメント更新**: 下記「ドキュメント更新ガイド」に従い、該当するドキュメントを更新

#### ドキュメント更新ガイド

実装完了後、以下のドキュメントを確認し、変更内容に応じて更新すること。

**必ず確認するドキュメント:**

| ドキュメント | 更新タイミング | 更新内容 |
|-------------|---------------|---------|
| `CLAUDE.md` | 新機能追加・アーキテクチャ変更時 | Development Context のプロジェクトステータス |
| `docs/implementation-status.md` | 機能追加・品質改善時 | 完了済み機能一覧、ステアリングディレクトリ一覧 |

**該当する場合に更新するドキュメント:**

| ドキュメント | 更新タイミング |
|-------------|---------------|
| `docs/agent-architecture.md` | エージェント・ツールの追加/変更時 |
| `docs/functional-design.md` | API仕様・データフローの変更時 |
| `docs/architecture.md` | 技術スタック・インフラの変更時 |
| `docs/firestore-design.md` | Firestoreスキーマの変更時 |

**更新チェックリスト:**
- [ ] `CLAUDE.md` の Development Context が最新の実装状態を反映しているか
- [ ] `docs/implementation-status.md` の完了済み機能一覧に今回の作業が記載されているか
- [ ] `docs/implementation-status.md` のステアリングディレクトリ一覧に今回の `.steering/` が追加されているか
- [ ] その他、変更内容に関連するドキュメントが最新か

#### Step 7: デプロイ準備（該当する場合）

本番環境へのデプロイが必要な場合、Phase 6 を実施:
- デプロイ手順書の作成
- 環境別設定の確認
- ロールバック手順の確認

### 4. ワークフロー完了

すべてのタスクが完了し、品質チェックをパスしたら:

1. `tasklist.md` の全項目が `[x]` になっていることを確認
2. ステアリングディレクトリに `COMPLETED.md` を作成し、完了サマリーを記述:
   - 実装内容の要約
   - 発生した問題と解決方法
   - 今後の改善点
   - 学んだこと（Lessons Learned）

## Claude Code の振る舞い

Claude Code（あなた）がこのワークフローを実行する際の指針：

### 必須動作

1. **ユーザーが新規実装や大規模作業を依頼した場合**:
   - まずステアリングディレクトリの作成を提案
   - requirements.md, design.md, tasklist.md を順番に作成
   - ユーザーの承認を得てから実装開始

2. **TDD原則の厳守**:
   - テストを書かずに実装コードを書かない
   - `/tdd` スキルを参照し、Red-Green-Refactorサイクルを守る

3. **段階的な進行**:
   - tasklist.md に記載されたタスクを順番に実行
   - 各タスク完了時、進捗を報告
   - 大きな変更を一度に行わない（ベイビーステップ）

4. **品質チェックの実施**:
   - 実装完了後、必ずセキュリティレビューとテストカバレッジ確認を実施
   - 問題が見つかった場合、修正してから完了とする

### 禁止事項

1. **ステアリングディレクトリなしでの大規模実装開始**
2. **tasklist.md の更新なしでの実装進行**
3. **テストなしでの実装コード追加**
4. **品質チェックのスキップ**

## 例: 初回実装の場合

```bash
# 1. ステアリングディレクトリ作成
mkdir -p .steering/20260131-initial-implementation

# 2. 必須ドキュメント作成
# - .steering/20260131-initial-implementation/requirements.md
# - .steering/20260131-initial-implementation/design.md
# - .steering/20260131-initial-implementation/tasklist.md

# 3. 環境セットアップ（tasklist.md Phase 1）

# 4. 実装開始（tasklist.md Phase 2-4）
# TDD原則に従い、テスト→実装を繰り返す

# 5. 品質チェック（tasklist.md Phase 5）

# 6. デプロイ準備（tasklist.md Phase 6、必要に応じて）

# 7. 完了サマリー作成
# - .steering/20260131-initial-implementation/COMPLETED.md
```

## 参考スキル

このワークフローを実行する際に参照すべきスキル：

- `/tdd` - テスト駆動開発の原則
- `/frontend` - フロントエンド実装時
- `/fastapi` - バックエンドAPI実装時
- `/google-adk-basics` - ADK基礎実装時
- `/google-adk-live` - Gemini Live API実装時
- `/git-workflow` - ブランチ戦略・コミット規約
- `/security-review` - セキュリティチェック時

## まとめ

このワークフローは、体系的かつ品質の高い実装を保証するためのものです。特に以下の点を重視しています：

1. **事前設計**: 実装前に要求・設計・タスクを明確化
2. **TDD実践**: テストファーストでの開発
3. **段階的実装**: 小さなステップでの着実な進行
4. **品質保証**: 実装後の徹底的な品質チェック
5. **ドキュメント化**: 作業内容と学びの記録
