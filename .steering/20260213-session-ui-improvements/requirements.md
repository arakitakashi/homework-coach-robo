# Requirements - セッションUI改善とバグ修正

## 背景・目的

セッション機能に関する複数のバグが報告されており、ユーザーエクスペリエンスに影響を与えている。これらのバグを一括で修正し、小学校低学年向けのUIとして適切な日本語表示を実現する。

## 要求事項

### 機能要件

#### 1. セッション間の対話履歴リセット (#115)

- 新しいセッション開始時に、前回セッションの対話履歴を完全にクリア
- 初期メッセージ「こんにちは！いっしょにがんばろうね！」のみ表示
- Jotai atomsの状態リセット処理を実装

#### 2. まほうつかいキャラクター画像表示 (#116)

- まほうつかい選択時にキャラクター画像を正しく表示
- 画像アセットの確認と、必要に応じて追加
- CharacterDisplayコンポーネントの修正

#### 3. ストーリー説明文のキャラクター連動 (#117)

- 選択キャラクターに応じた名前表示
- 各キャラクターの表示名:
  - robot → ロボ
  - wizard → まほうつかい
  - astronaut → うちゅうひこうし
  - animal → どうぶつ

#### 4. 音声録音ボタンの再セッション時の状態修正 (#118)

- 新セッション開始時に音声録音ボタンを「話しかけてね」状態で有効化
- WebSocket接続の適切なクリーンアップ
- マイクアクセス状態の正しい管理

#### 5. 404ページの日本語化 (#119)

- カスタム404ページの作成（`not-found.tsx`）
- 小学校低学年向けの優しい日本語表現
- トップページへの導線を明確に表示

#### 6. 不正なcharacterパラメータのバリデーション (#120)

- 有効なキャラクター値: `robot`, `wizard`, `astronaut`, `animal`
- 不正な値の場合、トップページにリダイレクト
- サーバーサイドでのパラメータ検証（Next.js App Router）

### 非機能要件

- **テストカバレッジ**: 新規・変更コードのカバレッジ80%以上
- **TDD原則**: すべての修正でテストファーストアプローチ
- **アクセシビリティ**: a11y属性の適切な設定
- **型安全性**: TypeScript strictモード準拠

### 制約条件

- 既存のJotai atoms構造を維持
- 既存のコンポーネントインターフェースを破壊しない
- バックエンドAPIの変更は行わない（フロントエンドのみで完結）

## 対象範囲

### In Scope

- セッション開始時の状態リセット処理
- キャラクター画像表示ロジック
- ストーリー説明文の動的生成
- 音声録音ボタンの状態管理
- 404ページのカスタマイズ
- characterパラメータのバリデーション
- 関連するテストの追加・修正

### Out of Scope

- バックエンドAPIの変更
- 新規キャラクターの追加
- セッション機能の大幅な仕様変更
- 音声認識エンジンの変更

## 成功基準

- [ ] すべてのissue (#115-#120) が解決される
- [ ] 手動テストで各バグが再現しないことを確認
- [ ] テストカバレッジ80%以上を維持
- [ ] CI（lint, typecheck, test）がすべてパス
- [ ] コードレビュー準備完了（CLAUDE.md, docs/implementation-status.md更新）
