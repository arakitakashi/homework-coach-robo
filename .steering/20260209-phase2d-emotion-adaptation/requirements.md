# Requirements - Phase 2d: 感情適応（バックエンド）

## 背景・目的

Phase 2b でマルチエージェント構成が完了し、Router Agent が教科ベースでサブエージェントに委譲する仕組みが稼働している。しかし、現在のルーティングは**テキスト内容のみ**に基づいており、子供の感情状態を考慮していない。

Phase 2d では、子供の発言テキストから感情を分析し、対話トーンとサポートレベルを動的に適応させる。これにより、フラストレーションが高い子供にはより穏やかに、自信がある子供にはチャレンジを促すなど、個別化された対話体験を実現する。

## 要求事項

### 機能要件

1. **感情分析ツール（`update_emotion_tool`）**
   - 感情スコア（frustration, confidence, fatigue, excitement: 各0.0-1.0）を session.state に記録
   - `ToolContext.state` 経由でセッション状態を更新

2. **Router Agent の感情対応強化**
   - session.state["emotion"] を参照して委譲判断に活用
   - 高フラストレーション時（>0.7）は encouragement_agent を優先
   - 高疲労時（>0.6）は休憩提案を促す

3. **サブエージェントプロンプトの感情コンテキスト注入**
   - 各サブエージェント（特に math_coach, japanese_coach）が感情状態を参照
   - 高フラストレーション → 小さいステップ、やさしいトーン
   - 高自信 → チャレンジ促進
   - 高疲労 → 短い問題、休憩提案

### 非機能要件

- テキストベースの分析のみ（音声トーン分析は Phase 3 以降）
- 感情分析は対話応答のレイテンシに影響しない設計
- 感情データが session.state に残らない場合でも既存動作に影響しない（フォールバック）

### 制約条件

- ADK FunctionTool インターフェース準拠
- 既存のエージェント構成（Router + 4 サブエージェント）を維持
- 既存テストが壊れない

## 対象範囲

### In Scope

- `update_emotion_tool`: 感情スコア記録ツール（#50）
- Router Agent プロンプト更新: 感情ベースのルーティング強化（#51）
- サブエージェントプロンプト更新: 感情コンテキスト参照（#51）
- ユニットテスト

### Out of Scope

- フロントエンド感情適応 UI（#64 — frontend 担当）
- 音声トーン分析・AutoML（#52 — Phase 3 以降）
- Emotion Analysis Agent（独立エージェントとしての実装は過剰設計、ツールのみで実現）

## 成功基準

- 504+ テスト通過（既存 504 + 新規）
- カバレッジ 80% 以上維持
- Ruff / mypy クリーン
- 感情スコアが session.state に正しく記録される
- Router Agent が高フラストレーション時に encouragement_agent を優先する
