# Requirements - Cloud Storage画像保存統合

## 背景・目的

### 背景

現在、ユーザーがアップロードした宿題画像はフロントエンドで一時的に保持されているのみで、永続化されていない。画像は学習履歴の重要な一部であり、以下の用途で必要となる：

- 子供の学習進捗の振り返り
- 保護者への学習状況報告
- 問題解決プロセスの記録
- AI エージェントによる画像分析の基礎データ

### 目的

ユーザーがアップロードした宿題画像を Google Cloud Storage に永続化し、そのメタデータ（URL、アップロード日時、ファイルサイズなど）を Firestore に保存することで、画像の長期保存と効率的なアクセスを実現する。

## 要求事項

### 機能要件

#### FR-1: 画像アップロード処理

- Base64エンコードされた画像データを受け取る
- サポートする画像形式: JPEG、PNG、WebP
- ファイルサイズ制限: 10MB以下
- 画像を Cloud Storage にアップロードする
- アップロードされた画像のパブリックURLを生成する
- 一時アクセス用の Signed URL を生成する（有効期限: 1時間）

#### FR-2: メタデータ保存

- Firestore のセッションドキュメントに以下の情報を保存:
  - Cloud Storage 上のファイルパス
  - パブリックURL（または Signed URL）
  - アップロード日時
  - ファイルサイズ
  - ファイル形式（MIME type）

#### FR-3: ファイル検証

- ファイルタイプの検証（magic number チェック）
- ファイルサイズの検証
- 不正なファイルの拒否（適切なエラーメッセージ）

#### FR-4: ストレージサービス

- Cloud Storage クライアントサービスの構築
- 依存性注入（DI）パターンでの実装
- テスト用モックサービスの提供

### 非機能要件

#### NFR-1: セキュリティ

- **最小権限の原則**: サービスアカウントには必要最小限の権限のみを付与
- **データ保護**: 子供の個人情報が含まれる可能性があるため、厳格なアクセス制御
- **入力検証**: すべての入力（ファイルタイプ、サイズ、内容）を検証
- **Signed URL**: パブリックアクセスを避け、期限付きURLを使用

#### NFR-2: パフォーマンス

- 画像アップロードのレスポンスタイム: 5秒以内（10MB画像の場合）
- 非同期処理の活用（async/await）

#### NFR-3: 信頼性

- エラーハンドリングの徹底
- リトライロジック（ネットワークエラー時）
- ロギングの充実（アップロード成功/失敗の記録）

#### NFR-4: 保守性

- テストカバレッジ: 80%以上
- 型ヒントの完全な使用
- 明確なエラーメッセージ

### 制約条件

#### CONS-1: インフラストラクチャ

- Cloud Storage バケット「homework-coach-assets」は Terraform で既にプロビジョニング済み
- バックエンドサービスアカウントには現在「objectViewer」権限あり
- 「objectCreator」ロールの追加が必要な可能性あり（Terraform で設定）

#### CONS-2: 技術スタック

- Python 3.10+
- FastAPI
- google-cloud-storage ライブラリ
- Firestore クライアント

#### CONS-3: 互換性

- 既存の Firestore スキーマとの互換性維持
- 既存のセッション管理との統合

## 対象範囲

### In Scope

- Cloud Storage クライアントサービスの実装
- 画像アップロード API の実装（内部サービスレイヤー）
- ファイル検証ロジック
- Signed URL 生成
- Firestore へのメタデータ保存
- ユニットテスト
- IAM 権限の更新（必要な場合）

### Out of Scope

- フロントエンドの実装（別 Issue で対応）
- 画像の自動リサイズ・圧縮（将来の最適化）
- 画像の削除機能（将来の機能）
- バックアップ・復元機能（インフラチームが別途対応）
- CDN 統合（将来の最適化）

## 成功基準

### SC-1: 機能の完全性

- [ ] JPEG、PNG、WebP形式の画像をアップロードできる
- [ ] 10MB以下の画像をアップロードできる
- [ ] アップロードされた画像の Signed URL を取得できる
- [ ] Firestore にメタデータが正しく保存される

### SC-2: セキュリティ

- [ ] 不正なファイルタイプが拒否される
- [ ] 10MBを超えるファイルが拒否される
- [ ] Signed URL が正しい有効期限（1時間）で生成される
- [ ] サービスアカウントの権限が最小限に設定されている

### SC-3: 品質

- [ ] ユニットテストカバレッジ 80% 以上
- [ ] 型チェック（mypy）エラーなし
- [ ] リンター（Ruff）エラーなし
- [ ] すべてのテストが通過

### SC-4: ドキュメント

- [ ] コード内のドキュメント文字列が充実している
- [ ] API 使用例が明確
- [ ] エラーメッセージが分かりやすい
