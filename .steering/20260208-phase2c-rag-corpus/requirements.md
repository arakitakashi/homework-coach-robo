# Requirements - Phase 2c: RAG Corpus作成・インデクシング

## 背景・目的

現在のMVP実装では、FirestoreMemoryServiceを使用したキーワードベースの記憶検索のみを実装している。これには以下の制約がある：

- **キーワードマッチのみ**: 完全一致または部分一致のみで、意味的な類似度を考慮できない
- **日本語対応が限定的**: 英語中心の実装で、日本語の文脈理解が不十分
- **過去の学習履歴を活かせない**: 子供の苦手分野や成功体験を文脈的に検索できない

Phase 2cでは、Vertex AI RAG Engineを導入し、セマンティック検索による個別化された学習体験を提供する。

## 要求事項

### 機能要件

1. **RAG Corpus作成**
   - Vertex AI RAG Corpusのプロビジョニング
   - Corpus設定（言語、埋め込みモデル、インデックス設定）
   - 開発環境用のCorpus初期化

2. **学習データのインデクシング**
   - 対話履歴のベクトル埋め込み化
   - 苦手分野パターンのインデクシング
   - 成功体験記録のインデクシング
   - カリキュラム情報のインデクシング

3. **search_memory_toolの実装**
   - VertexAiSearchToolをADKエージェントに統合
   - セマンティック検索クエリの実装
   - 検索結果のフィルタリング（関連度スコア閾値設定）

4. **検索精度の検証**
   - サンプルクエリに対する検索結果の評価
   - 関連度スコアの妥当性確認
   - 日本語クエリの精度検証

### 非機能要件

1. **パフォーマンス**
   - 検索レスポンス時間: < 500ms
   - インデクシング処理: バッチ処理で実行
   - エージェント応答への影響を最小化

2. **可用性**
   - RAG検索失敗時のフォールバック（Firestoreキーワード検索）
   - エラーハンドリングとリトライロジック

3. **セキュリティ**
   - 子供のプライバシー保護（個人識別情報のマスキング）
   - Corpusへのアクセス制御（IAM設定）

4. **テストカバレッジ**
   - ユニットテストカバレッジ80%以上
   - 統合テストによる検索精度検証

### 制約条件

1. **技術的制約**
   - Vertex AI RAG Engineの利用可能リージョン（us-central1等）
   - 埋め込みモデル: text-multilingual-embedding-002（日本語対応）
   - ADK VertexAiSearchTool APIの制約

2. **データ制約**
   - 初期インデクシング対象: 開発環境のサンプルデータのみ
   - 本番データは後続フェーズで移行

3. **時間的制約**
   - Phase 2cの実装期間内で完了
   - Phase 2dと並行開発可能

## 対象範囲

### In Scope

- RAG Corpus作成とプロビジョニング
- 学習履歴データ（対話、苦手分野、成功体験、カリキュラム）のインデクシング
- search_memory_toolの実装とエージェント統合
- 検索精度の検証
- Review Agentへの統合

### Out of Scope

- 本番環境の大規模データ移行（Phase 3で実施）
- FirestoreMemoryServiceの完全廃止（当面は並存）
- 音声トーン分析との統合（Phase 2dで実施）
- カスタム埋め込みモデルの訓練（標準モデルを使用）

## 成功基準

- [x] Vertex AI RAG Corpusが作成され、GCP環境で利用可能
- [x] サンプル学習データ（100件以上）がインデクシングされている
- [x] search_memory_toolが実装され、Review Agentで使用可能
- [x] サンプルクエリに対する検索精度が70%以上（関連度評価）
- [x] TDDに従った実装（テスト先行、カバレッジ80%以上）
- [x] 全CI/CDチェックがパス（lint, type check, test）
