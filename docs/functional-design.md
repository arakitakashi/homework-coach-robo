# å®¿é¡Œã‚³ãƒ¼ãƒãƒ­ãƒœãƒƒãƒˆ - æ©Ÿèƒ½è¨­è¨ˆæ›¸

**Document Version**: 1.4
**Last Updated**: 2026-01-29
**Status**: MVPè¨­è¨ˆå®Œäº†

---

## 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### 1.1 å…¨ä½“æ§‹æˆ

```mermaid
graph TB
    subgraph Frontend["ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å±¤ (Cloud Run)"]
        NextJS["Next.js<br/>SSR/API Routes"]
        VoiceUI["éŸ³å£°UI<br/>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ"]
        Character["ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼<br/>ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³"]
        Progress["é€²æ—è¡¨ç¤º<br/>ã‚²ãƒ¼ãƒŸãƒ•ã‚£"]
    end

    subgraph Backend["ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å±¤ (Cloud Run)"]
        FastAPI["FastAPI<br/>WebSocket Server"]
        WSHandler["WebSocketHandler"]
        SessionService["FirestoreSessionService"]
        BQService["BigQueryDataService"]
        Auth["Firebase Auth"]
    end

    subgraph Dialogue["å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³å±¤ (ADK)"]
        ADKRunner["ADK Runner"]
        Agent["Homework Coach Agent"]
        SocraticEngine["ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼<br/>å¯¾è©±ãƒãƒãƒ¼ã‚¸ãƒ£"]
        HintSystem["3æ®µéš<br/>ãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ "]
        StateTracker["å¯¾è©±çŠ¶æ…‹<br/>ãƒˆãƒ©ãƒƒã‚«ãƒ¼"]
    end

    subgraph AIML["AI/ML ã‚µãƒ¼ãƒ“ã‚¹å±¤ (Google Cloud)"]
        GeminiLive["Gemini Live API<br/>(Native Audio)"]
        STT["Cloud Speech-to-Text<br/>(éŸ³å£°èªè­˜)"]
        TTS["Cloud Text-to-Speech<br/>(éŸ³å£°åˆæˆ)"]
        Emotion["æ„Ÿæƒ…èªè­˜<br/>(Phase 2)"]
    end

    subgraph Data["ãƒ‡ãƒ¼ã‚¿å±¤ (Google Cloud)"]
        Firestore["Cloud Firestore<br/>(ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿)"]
        BigQuery["BigQuery<br/>(å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–)"]
        Redis["Memorystore Redis<br/>(ã‚­ãƒ£ãƒƒã‚·ãƒ¥)"]
    end

    %% ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ â†’ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
    Frontend -.WebSocket/REST.-> FastAPI

    %% ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å†…éƒ¨ãƒ•ãƒ­ãƒ¼
    FastAPI --> WSHandler
    WSHandler --> SessionService
    WSHandler --> BQService
    FastAPI --> Auth

    %% ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ â†’ å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³
    WSHandler --> ADKRunner
    ADKRunner --> Agent
    Agent --> SocraticEngine
    Agent --> HintSystem
    SessionService --> StateTracker

    %% å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³ â†’ AI/ML
    Agent --> GeminiLive
    SocraticEngine -.éŸ³å£°æ–‡å­—èµ·ã“ã—.-> STT
    SocraticEngine -.éŸ³å£°åˆæˆ.-> TTS
    StateTracker -.Phase 2.-> Emotion

    %% ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
    SessionService --> Firestore
    BQService --> BigQuery
    SocraticEngine --> Redis
    TTS --> Redis

    %% ã‚¹ã‚¿ã‚¤ãƒ«
    classDef frontend fill:#e1f5ff,stroke:#01579b,stroke-width:2px
    classDef backend fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dialogue fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef aiml fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef data fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class Frontend,VoiceUI,Character,Progress frontend
    class Backend,FastAPI,WSHandler,SessionService,BQService,Auth backend
    class Dialogue,ADKRunner,Agent,SocraticEngine,HintSystem,StateTracker dialogue
    class AIML,GeminiLive,STT,TTS,Emotion aiml
    class Data,Firestore,BigQuery,Redis data
```

**ä¸»è¦ãªé€šä¿¡ãƒ•ãƒ­ãƒ¼:**

1. **éŸ³å£°å…¥åŠ›ãƒ•ãƒ­ãƒ¼**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ WebSocket â†’ ADK Runner â†’ Gemini Live API
2. **éŸ³å£°å‡ºåŠ›ãƒ•ãƒ­ãƒ¼**: Gemini Live API â†’ ADK Events â†’ WebSocket â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
3. **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: SessionService â†” Firestoreï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜ï¼‰
4. **å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–**: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ â†’ BigQueryDataService â†’ BigQuery
5. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºãƒ»éŸ³å£°ãƒ‡ãƒ¼ã‚¿ â†’ Redis

**Cloud Runè¨­å®šæ–¹é‡:**
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹0ï¼ˆã‚³ã‚¹ãƒˆæœ€é©åŒ–ï¼‰
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹0ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰ã€1ï¼ˆæœ¬ç•ªç’°å¢ƒã€WebSocketç¶­æŒï¼‰

### 1.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ï¼ˆMVPï¼‰

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Next.js 14+ (App Router)
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : Bun 1.0+ï¼ˆé«˜é€ŸJavaScript/TypeScriptãƒ©ãƒ³ã‚¿ã‚¤ãƒ ï¼‰
- éŸ³å£°å‡¦ç†: Web Audio API (PCM 16kHzå½¢å¼)
- WebSocket: ãƒã‚¤ãƒ†ã‚£ãƒ– WebSocket API
- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³: Rive (https://rive.app/)
- çŠ¶æ…‹ç®¡ç†: Jotaiï¼ˆAtomicçŠ¶æ…‹ç®¡ç†ã€App Routerå¯¾å¿œï¼‰
- ãƒ‡ãƒ—ãƒ­ã‚¤: Cloud Run (ã‚³ãƒ³ãƒ†ãƒŠ)
- é™çš„ã‚¢ã‚»ãƒƒãƒˆé…ä¿¡: Cloud Storage + Cloud CDN

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆGoogle Cloud Platformï¼‰**
- ãƒ©ãƒ³ã‚¿ã‚¤ãƒ : Python 3.10+
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: FastAPI
- WebSocket: FastAPI WebSocket
- API: REST + WebSocketï¼ˆåŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼‰
- ãƒ‡ãƒ—ãƒ­ã‚¤: Cloud Run

**AI/MLã‚µãƒ¼ãƒ“ã‚¹ï¼ˆGoogle Cloudï¼‰**
- **LLM**: Google ADK (Agent Development Kit) + Gemini Live API
  - ãƒ¢ãƒ‡ãƒ«: `gemini-2.5-flash-native-audio-preview`ï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–éŸ³å£°å¯¾å¿œï¼‰
  - SDK: `google-adk` (Python)
  - API: Vertex AI Live API
  - **ãƒãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«å¯¾å¿œ**: éŸ³å£° + ç”»åƒã®åŒæ™‚å‡¦ç†
- **STT**: Cloud Speech-to-Text API
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°èªè­˜
  - æ—¥æœ¬èªå…ç«¥éŸ³å£°æœ€é©åŒ–
- **TTS**: Cloud Text-to-Speech API
  - WaveNetéŸ³å£°ï¼ˆè‡ªç„¶ãªç™ºè©±ï¼‰
  - ã‚«ã‚¹ã‚¿ãƒ å£°è³ªè¨­å®šï¼ˆåŠ±ã¾ã—/èª¬æ˜/å…±æ„Ÿï¼‰
- **ç”»åƒèªè­˜**: Gemini Vision + Cloud Vision API
  - OCRï¼ˆæ‰‹æ›¸ããƒ»å°åˆ·æ–‡å­—èªè­˜ï¼‰
  - æ•°å¼èªè­˜
  - å›³å½¢ãƒ»å›³è¡¨èªè­˜
  - å•é¡Œæ–‡ã®è‡ªå‹•æŠ½å‡º
- **æ„Ÿæƒ…èªè­˜**: ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ï¼ˆãƒ•ã‚§ãƒ¼ã‚º2ï¼‰
  - Vertex AI AutoML / Custom Training

**ãƒ‡ãƒ¼ã‚¿å±¤ï¼ˆGoogle Cloudï¼‰**
- **ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†**: Cloud Firestore
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸ
  - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚µãƒãƒ¼ãƒˆ
- **å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–**: BigQuery
  - å¯¾è©±å±¥æ­´ã®åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ã‚¦ã‚§ã‚¢ãƒã‚¦ã‚¹
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼å­¦ç¿’é€²æ—ã®é•·æœŸä¿å­˜
  - é›†è¨ˆãƒ»åˆ†æã‚¯ã‚¨ãƒªã®é«˜é€Ÿå®Ÿè¡Œ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿**: Cloud Firestore
  - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
  - è¨­å®šæƒ…å ±
  - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€²æ—
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Cloud Memorystore for Redis
  - ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã®éŸ³å£°ã‚­ãƒ£ãƒƒã‚·ãƒ¥
  - ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã®ä¸€æ™‚ä¿å­˜
- **å•é¡Œãƒãƒ³ã‚¯**: Cloud Firestore Collections
  - å•é¡Œãƒ‡ãƒ¼ã‚¿ã®éšå±¤æ§‹é€ ç®¡ç†

**èªè¨¼**
- Firebase Authentication
  - å­ä¾›ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†
  - ä¿è­·è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æº

**ã‚¤ãƒ³ãƒ•ãƒ©**
- **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°**: Cloud Runï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ»ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ä¸¡æ–¹ï¼‰
- **ã‚³ãƒ³ãƒ†ãƒŠ**: Dockerï¼ˆCloud Runç”¨ï¼‰
- **CI/CD**: Cloud Build + GitHub Actions
- **ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°**: Cloud Logging + Cloud Monitoring
- **ç’°å¢ƒå¤‰æ•°**: Secret Manager

**é–‹ç™ºç’°å¢ƒ**
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**: Bunï¼ˆé«˜é€Ÿã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ»ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ„ãƒ¼ãƒ«ï¼‰
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**: uvï¼ˆRustè£½é«˜é€ŸPythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ï¼‰
- **ä¸»è¦ä¾å­˜é–¢ä¿‚**:
  - `google-adk>=1.20.0`
  - `fastapi>=0.115.0`
  - `google-cloud-speech>=2.20.0`
  - `google-cloud-texttospeech>=2.14.0`
  - `google-cloud-firestore>=2.11.0`
  - `google-cloud-bigquery>=3.10.0`
  - `python-dotenv>=1.0.0`

### 1.3 ADK 4ãƒ•ã‚§ãƒ¼ã‚ºãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

Google ADKã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ãè¨­è¨ˆï¼š

#### ãƒ•ã‚§ãƒ¼ã‚º1: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆèµ·å‹•æ™‚ã«1å›ï¼‰
```python
# Agentã€SessionServiceã€Runnerã‚’ä½œæˆ
agent = Agent(
    name="homework_coach",
    model="gemini-2.5-flash-native-audio-preview",
    tools=[hint_system, problem_analyzer],
    instruction="ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼å¯¾è©±ã§ãƒ’ãƒ³ãƒˆã‚’æä¾›"
)

session_service = FirestoreSessionService()  # Firestoreå®Ÿè£…
runner = Runner(
    app_name="homework-coach",
    agent=agent,
    session_service=session_service
)
```

#### ãƒ•ã‚§ãƒ¼ã‚º2: ã‚»ãƒƒã‚·ãƒ§ãƒ³åˆæœŸåŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ¥ç¶šã”ã¨ï¼‰
```python
# ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—/ä½œæˆ
session = await session_service.get_session(
    app_name="homework-coach",
    user_id=user_id,
    session_id=session_id
)

# RunConfigè¨­å®š
run_config = RunConfig(
    streaming_mode=StreamingMode.BIDI,
    response_modalities=["AUDIO"],
    input_audio_transcription=AudioTranscriptionConfig(),
    output_audio_transcription=AudioTranscriptionConfig(),
)

# LiveRequestQueueä½œæˆ
live_request_queue = LiveRequestQueue()
```

#### ãƒ•ã‚§ãƒ¼ã‚º3: åŒæ–¹å‘ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé€šä¿¡ï¼‰
```python
# ä¸Šæµã‚¿ã‚¹ã‚¯: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚­ãƒ¥ãƒ¼
async def upstream_task():
    while True:
        message = await websocket.receive()
        if "bytes" in message:
            # éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ¥ãƒ¼ã«é€ä¿¡
            audio_blob = Blob(
                mime_type="audio/pcm;rate=16000",
                data=message["bytes"]
            )
            live_request_queue.send_realtime(audio_blob)

# ä¸‹æµã‚¿ã‚¹ã‚¯: ã‚¤ãƒ™ãƒ³ãƒˆ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
async def downstream_task():
    async for event in runner.run_live(
        user_id=user_id,
        session_id=session_id,
        live_request_queue=live_request_queue,
        run_config=run_config
    ):
        await websocket.send_text(event.model_dump_json())

# ä¸¦è¡Œå®Ÿè¡Œ
await asyncio.gather(upstream_task(), downstream_task())
```

#### ãƒ•ã‚§ãƒ¼ã‚º4: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
```python
finally:
    live_request_queue.close()
    # BigQueryã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šåŒ–
    await save_session_to_bigquery(session)
```

### 1.4 ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å›³

```mermaid
graph TB
    subgraph Actors
        Child((å­ä¾›<br/>å°å­¦1-3å¹´ç”Ÿ))
        Parent((ä¿è­·è€…))
        System((ã‚·ã‚¹ãƒ†ãƒ ))
    end

    subgraph "ä¸»è¦ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹"
        UC1[ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹]
        UC2[å•é¡Œã‚’è§£ã]
        UC3[ãƒ’ãƒ³ãƒˆã‚’è¦æ±‚]
        UC4[éŸ³å£°ã§å¯¾è©±]
        UC5[ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†]
        UC6[é€²æ—ç¢ºèª]
        UC7[è¨­å®šå¤‰æ›´]
        UC8[å­¦ç¿’å±¥æ­´ç¢ºèª]
    end

    subgraph "ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹"
        UC9[éŸ³å£°èªè­˜]
        UC10[ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼è³ªå•ç”Ÿæˆ]
        UC11[æ„Ÿæƒ…çŠ¶æ…‹åˆ†æ]
        UC12[å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿å­˜]
        UC13[ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥]
    end

    Child --> UC1
    Child --> UC2
    Child --> UC3
    Child --> UC4
    Child --> UC5
    Child --> UC7

    Parent --> UC6
    Parent --> UC8

    UC1 --> System
    UC2 --> UC4
    UC4 --> UC9
    UC9 --> UC10
    UC2 --> UC3
    UC4 --> UC11
    UC5 --> UC12
    UC12 --> UC13
    UC13 --> Parent

    style Child fill:#e1f5ff
    style Parent fill:#fff3e0
    style System fill:#f3e5f5
```

**ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹è©³ç´°:**

| ID | ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ | ã‚¢ã‚¯ã‚¿ãƒ¼ | èª¬æ˜ | å„ªå…ˆåº¦ |
|----|------------|---------|------|--------|
| UC1 | ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ | å­ä¾› | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠã€å®¿é¡Œé–‹å§‹ | é«˜ |
| UC2 | å•é¡Œã‚’è§£ã | å­ä¾› | å•é¡Œã‚’éŸ³å£°ã§èª­ã¿ä¸Šã’ã€å›ç­” | é«˜ |
| UC3 | ãƒ’ãƒ³ãƒˆã‚’è¦æ±‚ | å­ä¾› | 3æ®µéšãƒ’ãƒ³ãƒˆã‚’é †ç•ªã«å–å¾— | é«˜ |
| UC4 | éŸ³å£°ã§å¯¾è©± | å­ä¾› | AIã¨éŸ³å£°ã§å¯¾è©±ã—ãªãŒã‚‰è€ƒãˆã‚‹ | é«˜ |
| UC5 | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº† | å­ä¾› | ä»Šæ—¥ã®çµæœã‚’ç¢ºèªã€ãƒã‚¤ãƒ³ãƒˆç²å¾— | é«˜ |
| UC6 | é€²æ—ç¢ºèª | ä¿è­·è€… | å­ä¾›ã®å­¦ç¿’çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç¢ºèª | ä¸­ |
| UC7 | è¨­å®šå¤‰æ›´ | å­ä¾›/ä¿è­·è€… | ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã€éŸ³å£°é€Ÿåº¦ç­‰ã‚’å¤‰æ›´ | ä½ |
| UC8 | å­¦ç¿’å±¥æ­´ç¢ºèª | ä¿è­·è€… | éå»ã®å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã€åˆ†æçµæœã‚’ç¢ºèª | ä¸­ |
| UC9 | éŸ³å£°èªè­˜ | ã‚·ã‚¹ãƒ†ãƒ  | å­ä¾›ã®éŸ³å£°ã‚’ãƒ†ã‚­ã‚¹ãƒˆåŒ– | é«˜ |
| UC10 | ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼è³ªå•ç”Ÿæˆ | ã‚·ã‚¹ãƒ†ãƒ  | ç­”ãˆã‚’æ•™ãˆãšã«å°ãè³ªå•ã‚’ç”Ÿæˆ | é«˜ |
| UC11 | æ„Ÿæƒ…çŠ¶æ…‹åˆ†æ | ã‚·ã‚¹ãƒ†ãƒ  | éŸ³å£°ãƒˆãƒ¼ãƒ³ã‹ã‚‰æ„Ÿæƒ…ã‚’æ¤œçŸ¥ | ä¸­ |
| UC12 | å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ä¿å­˜ | ã‚·ã‚¹ãƒ†ãƒ  | ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«BigQueryã«ä¿å­˜ | é«˜ |
| UC13 | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ | ã‚·ã‚¹ãƒ†ãƒ  | ä¿è­·è€…ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ³ã‚’é€šçŸ¥ | ä¸­ |

### 1.5 ç”»é¢é·ç§»å›³

```mermaid
stateDiagram-v2
    [*] --> Login: ã‚¢ãƒ—ãƒªèµ·å‹•
    Login --> Home: èªè¨¼æˆåŠŸ

    Home --> CharacterSelect: æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
    Home --> ParentDashboard: ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰
    Home --> Settings: è¨­å®š

    CharacterSelect --> Session: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠ

    Session --> ProblemSolving: å•é¡Œé–‹å§‹
    ProblemSolving --> HintView: ãƒ’ãƒ³ãƒˆè¦æ±‚
    HintView --> ProblemSolving: ãƒ’ãƒ³ãƒˆç¢ºèª
    ProblemSolving --> CelebrationView: æ­£è§£
    CelebrationView --> ProblemSolving: æ¬¡ã®å•é¡Œ
    CelebrationView --> ResultView: å…¨å•é¡Œå®Œäº†

    ProblemSolving --> BreakView: ä¼‘æ†©ææ¡ˆ
    BreakView --> ProblemSolving: å†é–‹

    ResultView --> Home: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†

    ParentDashboard --> Home: æˆ»ã‚‹
    Settings --> Home: ä¿å­˜

    state ProblemSolving {
        [*] --> Listening
        Listening --> Thinking: éŸ³å£°èªè­˜å®Œäº†
        Thinking --> Speaking: è³ªå•ç”Ÿæˆå®Œäº†
        Speaking --> Listening: å­ä¾›ã®å¿œç­”å¾…ã¡
    }
```

**ç”»é¢é·ç§»ã®èª¬æ˜:**

1. **Login** â†’ **Home**
   - Firebase Authenticationã§èªè¨¼
   - åˆå›ã¯ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«è¨­å®š

2. **Home** â†’ **CharacterSelect**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é¸æŠç”»é¢ã¸

3. **CharacterSelect** â†’ **Session**
   - ãƒ­ãƒœãƒƒãƒˆ/é­”æ³•ä½¿ã„/å®‡å®™é£›è¡Œå£«/å‹•ç‰©ã‹ã‚‰é¸æŠ
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”»é¢ã«é·ç§»

4. **Session** â†’ **ProblemSolving**
   - AIãŒã€Œä»Šæ—¥ã¯ä½•ã®å®¿é¡Œï¼Ÿã€ã¨è³ªå•
   - å­ä¾›ãŒå•é¡Œã‚’èª­ã¿ä¸Šã’ã‚‹

5. **ProblemSolving**ï¼ˆçŠ¶æ…‹é·ç§»ï¼‰
   - Listening: å­ä¾›ã®éŸ³å£°ã‚’èã„ã¦ã„ã‚‹
   - Thinking: AIãŒè€ƒãˆä¸­
   - Speaking: AIãŒè³ªå•/ãƒ’ãƒ³ãƒˆã‚’è©±ã™

6. **ProblemSolving** â†’ **HintView**
   - å®ç®±ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
   - ãƒ’ãƒ³ãƒˆè¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ«

7. **ProblemSolving** â†’ **CelebrationView**
   - æ­£è§£æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒã‚¤ãƒ³ãƒˆç²å¾—æ¼”å‡º

8. **CelebrationView** â†’ **ResultView**
   - å…¨å•é¡Œå®Œäº†æ™‚
   - ä»Šæ—¥ã®æˆæœã‚’è¡¨ç¤º

9. **Home** â†’ **ParentDashboard**
   - ä¿è­·è€…ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
   - å­ä¾›ã®å­¦ç¿’çŠ¶æ³ç¢ºèª

### 1.6 ãƒ¯ã‚¤ãƒ¤ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆä¸»è¦ç”»é¢ï¼‰

#### 1.6.1 Homeç”»é¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å®¿é¡Œã‚³ãƒ¼ãƒãƒ­ãƒœãƒƒãƒˆ          [è¨­å®š] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚      [ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³]         â”‚
â”‚                                     â”‚
â”‚      ã“ã‚“ã«ã¡ã¯ã€ãŸã‚ã†ãã‚“ï¼       â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚  ä»Šæ—¥ã®å®¿é¡Œã‚’ã¯ã˜ã‚ã‚‹  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚   â”‚ ä»Šæ—¥ã®  â”‚  â”‚ ã“ã‚Œã¾ã§â”‚         â”‚
â”‚   â”‚ ãƒã‚¤ãƒ³ãƒˆâ”‚  â”‚  ã®è¨˜éŒ² â”‚         â”‚
â”‚   â”‚  120pt â”‚  â”‚  50å•  â”‚         â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                     â”‚
â”‚   [ä¿è­·è€…ã®æ–¹ã¯ã“ã¡ã‚‰]              â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.6.2 Sessionç”»é¢ï¼ˆéŸ³å£°å¯¾è©±ä¸­ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æˆ»ã‚‹]              å•é¡Œ 1/5  [Ã—] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â”‚ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼â”‚              â”‚
â”‚        â”‚ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³â”‚              â”‚
â”‚        â”‚  (Speaking) â”‚              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                     â”‚
â”‚   ã€Œã“ã®å•é¡Œã€ä½•ã‚’èã„ã¦ã‚‹ã¨æ€ã†ï¼Ÿã€ â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚                     â”‚           â”‚
â”‚   â”‚  éŸ³å£°ãƒ¬ãƒ™ãƒ«è¡¨ç¤º      â”‚           â”‚
â”‚   â”‚  [â”â”â”â”â”â”    ]      â”‚           â”‚
â”‚   â”‚                     â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â”‚
â”‚   [ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹]  [ä¼‘æ†©ã™ã‚‹]        â”‚
â”‚                                     â”‚
â”‚   ä½¿ã£ãŸãƒ’ãƒ³ãƒˆ: 0/3                 â”‚
â”‚   ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: +5pt                â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.6.3 HintViewï¼ˆå®ç®±æ¼”å‡ºï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             ãƒ’ãƒ³ãƒˆ                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â”‚   å®ç®±      â”‚              â”‚
â”‚        â”‚ ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³â”‚              â”‚
â”‚        â”‚  (Opening)  â”‚              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                     â”‚
â”‚      ã‚­ãƒ©ã‚­ãƒ© âœ¨ ã‚­ãƒ©ã‚­ãƒ© âœ¨         â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ ãƒ’ãƒ³ãƒˆ 1                â”‚       â”‚
â”‚   â”‚                         â”‚       â”‚
â”‚   â”‚ ã“ã®å•é¡Œã¯ä½•ã«ã¤ã„ã¦    â”‚       â”‚
â”‚   â”‚ èã„ã¦ã„ã¾ã™ã‹ï¼Ÿ        â”‚       â”‚
â”‚   â”‚                         â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚        [æ¬¡ã®ãƒ’ãƒ³ãƒˆ]  [é–‰ã˜ã‚‹]       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.6.4 ResultViewï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ä»Šæ—¥ã®æˆæœï¼               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚    â”‚  ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼    â”‚              â”‚
â”‚    â”‚  (Celebrating)  â”‚              â”‚
â”‚    â”‚   ã‚ˆãã§ããŸã­ï¼ â”‚              â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ è§£ã„ãŸå•é¡Œ: 5å•          â”‚       â”‚
â”‚   â”‚ è‡ªåˆ†ã§æ°—ã¥ã„ãŸ: 3å• â­    â”‚       â”‚
â”‚   â”‚ ãƒ’ãƒ³ãƒˆã§è§£ã„ãŸ: 2å•      â”‚       â”‚
â”‚   â”‚                         â”‚       â”‚
â”‚   â”‚ ç²å¾—ãƒã‚¤ãƒ³ãƒˆ: +25pt ğŸ‰  â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚ ä»Šæ—¥ã®ã™ã”ã„ã¨ã“ã‚ï¼     â”‚       â”‚
â”‚   â”‚                         â”‚       â”‚
â”‚   â”‚ âœ… æœ€åˆã‹ã‚‰æœ€å¾Œã¾ã§     â”‚       â”‚
â”‚   â”‚    ã‚ãã‚‰ã‚ãªã‹ã£ãŸï¼   â”‚       â”‚
â”‚   â”‚                         â”‚       â”‚
â”‚   â”‚ âœ… ã‚€ãšã‹ã—ã„å•é¡Œã§ã‚‚   â”‚       â”‚
â”‚   â”‚    è‡ªåˆ†ã§è€ƒãˆãŸï¼       â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                     â”‚
â”‚        [ãŠã‚ã‚‹]  [ã‚‚ã£ã¨ã‚„ã‚‹]       â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.6.5 ParentDashboardï¼ˆä¿è­·è€…ç”»é¢ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰    [ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  ãŸã‚ã†ãã‚“ã®å­¦ç¿’çŠ¶æ³               â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ä»Šé€±ã®å­¦ç¿’                â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: 5å›         â”‚        â”‚
â”‚  â”‚ è§£ã„ãŸå•é¡Œ: 25å•          â”‚        â”‚
â”‚  â”‚ è‡ªåŠ›è§£ç­”ç‡: 60%          â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ [é€±]  [æœˆ]  [å…¨æœŸé–“]    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ ã¤ã¾ãšããƒã‚¤ãƒ³ãƒˆ          â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ ğŸ”¸ ç¹°ã‚Šä¸ŠãŒã‚Šã®è¨ˆç®—      â”‚        â”‚
â”‚  â”‚   (3å›ã¤ã¾ãšã)         â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ ğŸ”¸ æ–‡ç« é¡Œã®ç†è§£          â”‚        â”‚
â”‚  â”‚   (2å›ã¤ã¾ãšã)         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚ æœ€è¿‘ã®æ´»å‹•               â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ ğŸ“… ä»Šæ—¥ 17:30           â”‚        â”‚
â”‚  â”‚    ç®—æ•°5å•ã‚¯ãƒªã‚¢ï¼       â”‚        â”‚
â”‚  â”‚    è‡ªåˆ†ã§3å•è§£ã„ãŸ â­    â”‚        â”‚
â”‚  â”‚                          â”‚        â”‚
â”‚  â”‚ ğŸ“… æ˜¨æ—¥ 18:00           â”‚        â”‚
â”‚  â”‚    å›½èª3å•ã‚¯ãƒªã‚¢         â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                     â”‚
â”‚         [è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’è¦‹ã‚‹]        â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 1.6.6 CameraViewï¼ˆå†™çœŸã§å•é¡Œèªè­˜ï¼‰

**çŠ¶æ…‹1: ã‚«ãƒ¡ãƒ©èµ·å‹•å‰**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [æˆ»ã‚‹]      å•é¡Œã‚’é¸ã¶             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â”‚ ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼â”‚              â”‚
â”‚        â”‚             â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                     â”‚
â”‚     å•é¡Œã‚’ã©ã†ã‚„ã£ã¦æ•™ãˆã‚‹ï¼Ÿ         â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  ğŸ¤ å£°ã§ä¼ãˆã‚‹       â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚   â”‚  ğŸ“· å†™çœŸã§ä¼ãˆã‚‹     â”‚           â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ…‹2: ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Ã—]              ã‚«ãƒ¡ãƒ©            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚      ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼        â”‚    â”‚
â”‚  â”‚      (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ˜ åƒ)      â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚    â”‚
â”‚  â”‚    â”‚  å•é¡Œå…¨ä½“ãŒå…¥ã‚‹  â”‚      â”‚    â”‚
â”‚  â”‚    â”‚  ã‚ˆã†ã«æ’®å½±ã—ã¦  â”‚      â”‚    â”‚
â”‚  â”‚    â”‚   ãã ã•ã„      â”‚      â”‚    â”‚
â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚        â”‚  ğŸ“¸ æ’®å½±ã™ã‚‹ â”‚              â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ…‹3: ç”»åƒå‡¦ç†ä¸­**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            å•é¡Œã‚’èªè­˜ä¸­...          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚      æ’®å½±ã—ãŸç”»åƒ            â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚            â³ å‡¦ç†ä¸­...             â”‚
â”‚                                     â”‚
â”‚         å•é¡Œã‚’èªè­˜ã—ã¦ã„ã¾ã™         â”‚
â”‚                                     â”‚
â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”            â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ…‹4: èªè­˜çµæœè¡¨ç¤º**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Ã—]          èªè­˜çµæœ              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚      æ’®å½±ã—ãŸç”»åƒ            â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ èªè­˜ã—ãŸå•é¡Œæ–‡:              â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚ 5 + 3 = ?                   â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚ ã“ã®å•é¡Œã¯ç®—æ•°ã®             â”‚    â”‚
â”‚  â”‚ ãŸã—ç®—ã®å•é¡Œã§ã™             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ ã“ã®å•é¡Œã§ â”‚  â”‚  æ’®ã‚Šç›´ã™ â”‚    â”‚
â”‚   â”‚  å§‹ã‚ã‚‹   â”‚  â”‚           â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**çŠ¶æ…‹5: èªè­˜ã‚¨ãƒ©ãƒ¼**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Ã—]            ã‚¨ãƒ©ãƒ¼              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚      æ’®å½±ã—ãŸç”»åƒ            â”‚    â”‚
â”‚  â”‚      (ã¼ã‚„ã‘ã¦ã„ã‚‹)          â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚        âš ï¸ å•é¡Œã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ  â”‚
â”‚                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ ã‚‚ã†ä¸€åº¦ã€ä»¥ä¸‹ã‚’è©¦ã—ã¦ãã ã•ã„:â”‚    â”‚
â”‚  â”‚                             â”‚    â”‚
â”‚  â”‚ âœ“ å•é¡Œå…¨ä½“ãŒå†™ã‚‹ã‚ˆã†ã«       â”‚    â”‚
â”‚  â”‚ âœ“ æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±           â”‚    â”‚
â”‚  â”‚ âœ“ æ–‡å­—ãŒã¯ã£ãã‚Šè¦‹ãˆã‚‹ã‚ˆã†ã« â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚   â”‚ ã‚‚ã†ä¸€åº¦  â”‚  â”‚ å£°ã§ä¼ãˆã‚‹ â”‚    â”‚
â”‚   â”‚  æ’®å½±ã™ã‚‹ â”‚  â”‚           â”‚    â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 2.1 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### 2.1.1 VoiceInterface
éŸ³å£°ã®éŒ²éŸ³ãƒ»å†ç”Ÿã‚’ç®¡ç†

**è²¬å‹™**
- ãƒã‚¤ã‚¯ã‹ã‚‰ã®éŸ³å£°å…¥åŠ›ã‚­ãƒ£ãƒ—ãƒãƒ£
- éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°é€ä¿¡
- å—ä¿¡ã—ãŸéŸ³å£°ã®å†ç”Ÿ
- éŸ³å£°ãƒ¬ãƒ™ãƒ«ã®å¯è¦–åŒ–

**çŠ¶æ…‹**
- `isRecording: boolean`
- `isPlaying: boolean`
- `audioLevel: number`
- `connectionStatus: 'connected' | 'disconnected' | 'connecting'`

**API**
```typescript
interface VoiceInterfaceProps {
  onAudioData: (audioBlob: Blob) => void;
  onTranscriptReceived: (text: string) => void;
  onResponseAudioReceived: (audioUrl: string) => void;
}
```

#### 2.1.2 CharacterAvatarï¼ˆRiveå®Ÿè£…ï¼‰
ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡¨ç¤ºã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

**è²¬å‹™**
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®è¡¨æƒ…ãƒ»å‹•ãã®è¡¨ç¤º
- å¯¾è©±çŠ¶æ…‹ã«å¿œã˜ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ï¼ˆéŸ³å£°ã«åˆã‚ã›ãŸå£ã®å‹•ãï¼‰
- éŸ³å£°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸåå¿œ

**Rive ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…**

```typescript
'use client';

import { useRive, useStateMachineInput } from '@rive-app/react-canvas';
import { useEffect } from 'react';

interface CharacterAvatarProps {
  characterType: 'robot' | 'wizard' | 'astronaut' | 'animal';
  emotionalState: 'neutral' | 'thinking' | 'excited' | 'encouraging';
  isSpeaking: boolean;
  audioLevel: number; // 0-100
}

export function CharacterAvatar({
  characterType,
  emotionalState,
  isSpeaking,
  audioLevel
}: CharacterAvatarProps) {
  // Riveãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆ.rivãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
  const { rive, RiveComponent } = useRive({
    src: `/characters/${characterType}.riv`,
    stateMachines: 'State Machine 1',
    autoplay: true,
  });

  // ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã®å…¥åŠ›ã‚’å–å¾—
  const emotionInput = useStateMachineInput(rive, 'State Machine 1', 'emotion');
  const speakingInput = useStateMachineInput(rive, 'State Machine 1', 'isSpeaking');
  const audioLevelInput = useStateMachineInput(rive, 'State Machine 1', 'audioLevel');

  // çŠ¶æ…‹å¤‰åŒ–æ™‚ã«Riveã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
  useEffect(() => {
    if (emotionInput) {
      emotionInput.value = getEmotionValue(emotionalState);
    }
  }, [emotionalState, emotionInput]);

  useEffect(() => {
    if (speakingInput) {
      speakingInput.value = isSpeaking;
    }
  }, [isSpeaking, speakingInput]);

  useEffect(() => {
    if (audioLevelInput) {
      audioLevelInput.value = audioLevel;
    }
  }, [audioLevel, audioLevelInput]);

  return (
    <div className="character-container">
      <RiveComponent className="character-avatar" />
    </div>
  );
}

function getEmotionValue(emotion: string): number {
  const emotionMap = {
    neutral: 0,
    thinking: 1,
    excited: 2,
    encouraging: 3,
  };
  return emotionMap[emotion] || 0;
}
```

**Rive ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³è¨­è¨ˆ**

Riveã‚¨ãƒ‡ã‚£ã‚¿ã§ä»¥ä¸‹ã®ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã‚’ä½œæˆï¼š

```
State Machine 1
â”œâ”€ å…¥åŠ›ï¼ˆInputsï¼‰
â”‚  â”œâ”€ emotion (Number: 0-3)
â”‚  â”œâ”€ isSpeaking (Boolean)
â”‚  â””â”€ audioLevel (Number: 0-100)
â”‚
â”œâ”€ çŠ¶æ…‹ï¼ˆStatesï¼‰
â”‚  â”œâ”€ Idle
â”‚  â”œâ”€ Listening
â”‚  â”œâ”€ Thinking
â”‚  â”œâ”€ Speaking
â”‚  â””â”€ Celebrating
â”‚
â””â”€ é·ç§»ï¼ˆTransitionsï¼‰
   â”œâ”€ Idle â†’ Listening (emotion == 0)
   â”œâ”€ Listening â†’ Thinking (emotion == 1)
   â”œâ”€ Thinking â†’ Speaking (isSpeaking == true)
   â”œâ”€ Speaking â†’ Idle (isSpeaking == false)
   â””â”€ Any â†’ Celebrating (emotion == 2)
```

**ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°**

| çŠ¶æ…‹ | ãƒˆãƒªã‚¬ãƒ¼ | ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ | Riveå®Ÿè£… |
|------|---------|---------------|----------|
| **Idle** | å¾…æ©Ÿä¸­ | ã‚†ã£ãã‚Šå‘¼å¸ã€ã¾ã°ãŸã | IdleçŠ¶æ…‹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ |
| **Listening** | å­ä¾›ãŒè©±ã—ã¦ã„ã‚‹ | è€³ã‚’å‚¾ã‘ã‚‹ã€é ·ã | audioLevelã«å¿œã˜ã¦é ­ãŒå‹•ã |
| **Thinking** | AIãŒè€ƒãˆä¸­ | é ­ã‚’å‚¾ã’ã‚‹ã€ã€Œã†ãƒ¼ã‚“ã€ | Thinkingã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ«ãƒ¼ãƒ— |
| **Speaking** | AIãŒè©±ã—ã¦ã„ã‚‹ | å£ãƒ‘ã‚¯ã€è¡¨æƒ…å¤‰åŒ– | audioLevelã§å£ã®é–‹ãå…·åˆã‚’åˆ¶å¾¡ |
| **Celebrating** | æ­£è§£ãƒ»è¤’ã‚ã‚‹ | ã‚¸ãƒ£ãƒ³ãƒ—ã€æ‹æ‰‹ã€ã‚­ãƒ©ã‚­ãƒ© | Celebratingã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ |

**ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯å®Ÿè£…**

```typescript
// éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’Riveã«é€ä¿¡ã—ã¦ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã‚’å®Ÿç¾
useEffect(() => {
  if (!isSpeaking) return;

  // Web Audio APIã§éŸ³å£°ãƒ¬ãƒ™ãƒ«ã‚’å–å¾—
  const analyser = audioContext.createAnalyser();
  analyser.fftSize = 256;
  const dataArray = new Uint8Array(analyser.frequencyBinCount);

  const updateAudioLevel = () => {
    analyser.getByteFrequencyData(dataArray);
    const average = dataArray.reduce((a, b) => a + b) / dataArray.length;
    const normalizedLevel = (average / 255) * 100;

    // Riveã®audioLevelå…¥åŠ›ã‚’æ›´æ–°
    if (audioLevelInput) {
      audioLevelInput.value = normalizedLevel;
    }

    if (isSpeaking) {
      requestAnimationFrame(updateAudioLevel);
    }
  };

  updateAudioLevel();
}, [isSpeaking, audioContext, audioLevelInput]);
```

**Riveãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**

```
public/characters/
â”œâ”€â”€ robot.riv          # ãƒ­ãƒœãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
â”œâ”€â”€ wizard.riv         # é­”æ³•ä½¿ã„ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
â”œâ”€â”€ astronaut.riv      # å®‡å®™é£›è¡Œå£«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼
â””â”€â”€ animal.riv         # å‹•ç‰©ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼

å„.rivãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ï¼š
- è¤‡æ•°ã®æ„Ÿæƒ…çŠ¶æ…‹ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã§ã®çŠ¶æ…‹é·ç§»
- éŸ³å£°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸå£ã®å‹•ã
- ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã®è‡ªå‹•ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
```

**Riveã®åˆ©ç‚¹ï¼ˆã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã®é¸æŠç†ç”±ï¼‰**

1. **ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³ã«ã‚ˆã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–åˆ¶å¾¡**
   - å¯¾è©±çŠ¶æ…‹ã«å¿œã˜ãŸè‡ªå‹•é·ç§»
   - ã‚³ãƒ¼ãƒ‰ã‹ã‚‰çŠ¶æ…‹ã‚’åˆ¶å¾¡ã—ã‚„ã™ã„

2. **ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå°ã•ã„**
   - .rivãƒ•ã‚¡ã‚¤ãƒ«: 50-200KB
   - Lottie JSON: 500KB-2MB
   - ç´„1/10ã®ã‚µã‚¤ã‚º

3. **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°**
   - éŸ³å£°ãƒ¬ãƒ™ãƒ«ã«å¿œã˜ãŸå‹•çš„åˆ¶å¾¡
   - ãƒªãƒƒãƒ—ã‚·ãƒ³ã‚¯ã®å®Ÿè£…ãŒå®¹æ˜“

4. **Reactå…¬å¼ã‚µãƒãƒ¼ãƒˆ**
   - `@rive-app/react-canvas`
   - `@rive-app/react-webgl`ï¼ˆé«˜åº¦ãªæ¼”å‡ºç”¨ï¼‰

5. **ã‚¯ãƒ­ã‚¹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ **
   - Webã€iOSã€Androidã€Unityã€Unreal
   - å°†æ¥çš„ãªãƒ¢ãƒã‚¤ãƒ«ã‚¢ãƒ—ãƒªå±•é–‹ãŒå®¹æ˜“

#### 2.1.3 HintBoxï¼ˆRiveå®Ÿè£…ï¼‰
ãƒ’ãƒ³ãƒˆã®è¡¨ç¤ºã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³

**è²¬å‹™**
- 3æ®µéšãƒ’ãƒ³ãƒˆã®è¡¨ç¤º
- ã€Œå®ç®±ã‚’é–‹ã‘ã‚‹ã€æ¼”å‡ºï¼ˆRiveã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- ãƒ’ãƒ³ãƒˆä½¿ç”¨å›æ•°ã®è¡¨ç¤º

**Riveå®Ÿè£…**

```typescript
'use client';

import { useRive, useStateMachineInput } from '@rive-app/react-canvas';
import { useState } from 'react';

interface HintBoxProps {
  hintLevel: 0 | 1 | 2 | 3;
  hintText: string;
  onHintRequest: () => void;
  hintsUsed: number;
}

export function HintBox({ hintLevel, hintText, onHintRequest, hintsUsed }: HintBoxProps) {
  const [isOpening, setIsOpening] = useState(false);

  const { rive, RiveComponent } = useRive({
    src: '/animations/treasure-chest.riv',
    stateMachines: 'Chest State Machine',
    autoplay: true,
  });

  const openTrigger = useStateMachineInput(rive, 'Chest State Machine', 'open');
  const sizeInput = useStateMachineInput(rive, 'Chest State Machine', 'size');

  const handleOpenChest = () => {
    setIsOpening(true);

    // å®ç®±ã®ã‚µã‚¤ã‚ºã‚’è¨­å®šï¼ˆãƒ’ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã«å¿œã˜ã¦ï¼‰
    if (sizeInput) {
      sizeInput.value = hintLevel;
    }

    // é–‹ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒªã‚¬ãƒ¼
    if (openTrigger) {
      openTrigger.fire();
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    setTimeout(() => {
      onHintRequest();
      setIsOpening(false);
    }, 1500); // Riveã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®é•·ã•ã«åˆã‚ã›ã‚‹
  };

  return (
    <div className="hint-box">
      {!isOpening && hintLevel === 0 && (
        <button onClick={handleOpenChest} className="treasure-button">
          <RiveComponent className="treasure-chest" />
          <span>ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</span>
        </button>
      )}

      {isOpening && (
        <div className="opening-animation">
          <RiveComponent className="treasure-chest-opening" />
        </div>
      )}

      {hintLevel > 0 && hintText && (
        <div className="hint-content">
          <div className="hint-badge">ãƒ’ãƒ³ãƒˆ {hintLevel}</div>
          <p>{hintText}</p>
          {hintLevel < 3 && (
            <button onClick={handleOpenChest} className="next-hint-button">
              æ¬¡ã®ãƒ’ãƒ³ãƒˆ
            </button>
          )}
        </div>
      )}

      <div className="hints-counter">
        ä½¿ã£ãŸãƒ’ãƒ³ãƒˆ: {hintsUsed}/3
      </div>
    </div>
  );
}
```

**Rive ã‚¹ãƒ†ãƒ¼ãƒˆãƒã‚·ãƒ³è¨­è¨ˆï¼ˆå®ç®±ï¼‰**

```
Chest State Machine
â”œâ”€ å…¥åŠ›ï¼ˆInputsï¼‰
â”‚  â”œâ”€ open (Trigger)
â”‚  â””â”€ size (Number: 1-3)
â”‚
â”œâ”€ çŠ¶æ…‹ï¼ˆStatesï¼‰
â”‚  â”œâ”€ Idle (é–‰ã˜ãŸå®ç®±)
â”‚  â”œâ”€ Opening (é–‹ãã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³)
â”‚  â”œâ”€ Opened (é–‹ã„ãŸçŠ¶æ…‹ã€ã‚­ãƒ©ã‚­ãƒ©)
â”‚  â””â”€ Closed (å†ã³é–‰ã˜ã‚‹)
â”‚
â””â”€ é·ç§»ï¼ˆTransitionsï¼‰
   â”œâ”€ Idle â†’ Opening (open triggered)
   â”œâ”€ Opening â†’ Opened (animation complete)
   â””â”€ Opened â†’ Idle (after 2 seconds)
```

**ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ¼”å‡ºè©³ç´°**

| ãƒ¬ãƒ™ãƒ« | å®ç®±ã‚µã‚¤ã‚º | è‰² | ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ |
|--------|-----------|-----|-----------|
| **ãƒ¬ãƒ™ãƒ«1** | å° | ãƒ–ãƒ­ãƒ³ã‚º | å°ã•ãªã‚­ãƒ©ã‚­ãƒ© |
| **ãƒ¬ãƒ™ãƒ«2** | ä¸­ | ã‚·ãƒ«ãƒãƒ¼ | ä¸­ç¨‹åº¦ã®ã‚­ãƒ©ã‚­ãƒ© |
| **ãƒ¬ãƒ™ãƒ«3** | å¤§ | ã‚´ãƒ¼ãƒ«ãƒ‰ | å¤§ããªã‚­ãƒ©ã‚­ãƒ© + å…‰ã®æŸ± |

**Riveãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**

```
public/animations/
â”œâ”€â”€ treasure-chest.riv    # å®ç®±ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€ Small Chest (Level 1)
â”‚   â”œâ”€ Medium Chest (Level 2)
â”‚   â””â”€ Large Chest (Level 3)
â””â”€â”€ sparkles.riv          # ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```

#### 2.1.4 ProgressTracker
å­¦ç¿’é€²æ—ã®å¯è¦–åŒ–

**è²¬å‹™**
- ä»Šæ—¥ã®é€²æ—è¡¨ç¤º
- ç²å¾—ãƒã‚¤ãƒ³ãƒˆã®è¡¨ç¤º
- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œã®è¡¨ç¤º

**è¡¨ç¤ºé …ç›®**
- è§£ã„ãŸå•é¡Œæ•°
- è‡ªåŠ›è§£ç­”æ•°
- ç²å¾—ãƒã‚¤ãƒ³ãƒˆ
- ç¾åœ¨ã®ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ä½ç½®

#### 2.1.5 CameraInterface
å†™çœŸã«ã‚ˆã‚‹å•é¡Œèªè­˜æ©Ÿèƒ½

**è²¬å‹™**
- ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒ»å†™çœŸæ’®å½±
- ç”»åƒã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
- ç”»åƒãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
- OCRçµæœã®è¡¨ç¤º
- èªè­˜ã‚¨ãƒ©ãƒ¼ã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

**çŠ¶æ…‹**
- `isCameraActive: boolean`
- `capturedImage: string | null`
- `isProcessing: boolean`
- `recognizedText: string | null`
- `recognitionError: string | null`

**å®Ÿè£…**

```typescript
'use client';

import { useState, useRef } from 'react';

interface CameraInterfaceProps {
  onImageCaptured: (imageData: string) => void;
  onTextRecognized: (text: string, problemData: ProblemData) => void;
  onError: (error: string) => void;
}

interface ProblemData {
  problemText: string;
  problemType: 'math' | 'reading' | 'writing';
  detectedEquations?: string[];
  detectedDiagrams?: boolean;
}

export function CameraInterface({
  onImageCaptured,
  onTextRecognized,
  onError
}: CameraInterfaceProps) {
  const [isCameraActive, setIsCameraActive] = useState(false);
  const [capturedImage, setCapturedImage] = useState<string | null>(null);
  const [isProcessing, setIsProcessing] = useState(false);
  const [recognizedText, setRecognizedText] = useState<string | null>(null);

  const videoRef = useRef<HTMLVideoElement>(null);
  const canvasRef = useRef<HTMLCanvasElement>(null);

  // ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•
  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: 'environment', // èƒŒé¢ã‚«ãƒ¡ãƒ©ã‚’å„ªå…ˆ
          width: { ideal: 1920 },
          height: { ideal: 1080 }
        }
      });

      if (videoRef.current) {
        videoRef.current.srcObject = stream;
        setIsCameraActive(true);
      }
    } catch (error) {
      onError('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¡ãƒ©ã®æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    }
  };

  // å†™çœŸã‚’æ’®å½±
  const capturePhoto = () => {
    if (!videoRef.current || !canvasRef.current) return;

    const video = videoRef.current;
    const canvas = canvasRef.current;
    const context = canvas.getContext('2d');

    if (!context) return;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ“ãƒ‡ã‚ªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    context.drawImage(video, 0, 0);

    // Base64å½¢å¼ã§ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const imageData = canvas.toDataURL('image/jpeg', 0.9);
    setCapturedImage(imageData);
    onImageCaptured(imageData);

    // ã‚«ãƒ¡ãƒ©ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢
    const stream = video.srcObject as MediaStream;
    stream?.getTracks().forEach(track => track.stop());
    setIsCameraActive(false);

    // ç”»åƒèªè­˜å‡¦ç†ã‚’é–‹å§‹
    processImage(imageData);
  };

  // ç”»åƒèªè­˜å‡¦ç†
  const processImage = async (imageData: string) => {
    setIsProcessing(true);

    try {
      const response = await fetch('/api/vision/recognize', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          image: imageData,
          recognitionType: 'homework_problem'
        })
      });

      if (!response.ok) {
        throw new Error('ç”»åƒèªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }

      const result = await response.json();

      setRecognizedText(result.problemText);
      onTextRecognized(result.problemText, {
        problemText: result.problemText,
        problemType: result.problemType,
        detectedEquations: result.equations,
        detectedDiagrams: result.hasDiagrams
      });

    } catch (error) {
      onError('å•é¡Œã®èªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚');
    } finally {
      setIsProcessing(false);
    }
  };

  // å†æ’®å½±
  const retakePhoto = () => {
    setCapturedImage(null);
    setRecognizedText(null);
    startCamera();
  };

  return (
    <div className="camera-interface">
      {!isCameraActive && !capturedImage && (
        <button onClick={startCamera} className="start-camera-button">
          ğŸ“· å†™çœŸã§å•é¡Œã‚’èªè­˜ã™ã‚‹
        </button>
      )}

      {isCameraActive && (
        <div className="camera-view">
          <video
            ref={videoRef}
            autoPlay
            playsInline
            className="camera-video"
          />
          <div className="camera-overlay">
            <div className="capture-guide">
              å•é¡Œå…¨ä½“ãŒå…¥ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„
            </div>
          </div>
          <button onClick={capturePhoto} className="capture-button">
            æ’®å½±ã™ã‚‹
          </button>
        </div>
      )}

      {capturedImage && (
        <div className="image-preview">
          <img src={capturedImage} alt="æ’®å½±ã—ãŸå•é¡Œ" />

          {isProcessing && (
            <div className="processing-overlay">
              <div className="spinner" />
              <p>å•é¡Œã‚’èªè­˜ã—ã¦ã„ã¾ã™...</p>
            </div>
          )}

          {recognizedText && !isProcessing && (
            <div className="recognition-result">
              <h3>èªè­˜ã—ãŸå•é¡Œæ–‡:</h3>
              <p className="recognized-text">{recognizedText}</p>
              <div className="action-buttons">
                <button onClick={() => {/* èªè­˜çµæœã‚’ç¢ºå®š */}} className="confirm-button">
                  ã“ã®å•é¡Œã§å§‹ã‚ã‚‹
                </button>
                <button onClick={retakePhoto} className="retake-button">
                  æ’®ã‚Šç›´ã™
                </button>
              </div>
            </div>
          )}
        </div>
      )}

      <canvas ref={canvasRef} style={{ display: 'none' }} />
    </div>
  );
}
```

**ç”»åƒèªè­˜ã®æµã‚Œ**

```mermaid
sequenceDiagram
    participant User as å­ä¾›
    participant Camera as CameraInterface
    participant API as Vision API
    participant Gemini as Gemini Vision

    User->>Camera: ã‚«ãƒ¡ãƒ©èµ·å‹•ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    Camera->>Camera: navigator.mediaDevices.getUserMedia()
    Camera->>User: ã‚«ãƒ¡ãƒ©ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º

    User->>Camera: æ’®å½±ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    Camera->>Camera: canvas.toDataURL()
    Camera->>API: POST /api/vision/recognize

    API->>Gemini: ç”»åƒ + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆé€ä¿¡
    Note over Gemini: å•é¡Œæ–‡æŠ½å‡º<br/>æ•°å¼èªè­˜<br/>å›³å½¢æ¤œå‡º

    Gemini->>API: èªè­˜çµæœ
    API->>Camera: å•é¡Œãƒ‡ãƒ¼ã‚¿
    Camera->>User: èªè­˜ã—ãŸå•é¡Œæ–‡è¡¨ç¤º

    User->>Camera: ã€Œã“ã®å•é¡Œã§å§‹ã‚ã‚‹ã€ã‚¯ãƒªãƒƒã‚¯
    Camera->>User: å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
```

**Gemini Vision ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­è¨ˆ**

```python
# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: /api/vision/recognize ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
VISION_PROMPT = """
ã‚ãªãŸã¯å°å­¦æ ¡ä½å­¦å¹´ï¼ˆ1ã€œ3å¹´ç”Ÿï¼‰ã®å®¿é¡Œå•é¡Œã‚’èªè­˜ã™ã‚‹AIã§ã™ã€‚
ç”»åƒã‹ã‚‰ä»¥ä¸‹ã®æƒ…å ±ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ï¼š

1. **å•é¡Œæ–‡**: ç”»åƒã«æ›¸ã‹ã‚Œã¦ã„ã‚‹å•é¡Œã®æ–‡ç« ã‚’æ­£ç¢ºã«èª­ã¿å–ã£ã¦ãã ã•ã„
2. **å•é¡Œã‚¿ã‚¤ãƒ—**: ç®—æ•°/å›½èª/ãã®ä»–ã‚’åˆ¤å®šã—ã¦ãã ã•ã„
3. **æ•°å¼**: æ•°å¼ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€LaTeXå½¢å¼ã§æŠ½å‡ºã—ã¦ãã ã•ã„
4. **å›³å½¢**: å›³å½¢ã‚„å›³è¡¨ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ã‚’åˆ¤å®šã—ã¦ãã ã•ã„

å‡ºåŠ›å½¢å¼ï¼ˆJSONï¼‰ï¼š
{
  "problemText": "å•é¡Œæ–‡å…¨ä½“",
  "problemType": "math" | "reading" | "writing",
  "equations": ["2 + 3 = ?", "x + 5 = 10"],
  "hasDiagrams": true | false,
  "confidence": 0.95
}

æ³¨æ„äº‹é …ï¼š
- æ‰‹æ›¸ãæ–‡å­—ã‚‚æ­£ç¢ºã«èª­ã¿å–ã£ã¦ãã ã•ã„
- æ¼¢å­—ã«ã¯ãƒ«ãƒ“ï¼ˆãµã‚ŠãŒãªï¼‰ãŒæŒ¯ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
- å•é¡Œç•ªå·ï¼ˆ1. 2. ãªã©ï¼‰ã¯å«ã‚ãªã„ã§ãã ã•ã„
"""

async def recognize_homework_problem(image_data: str) -> dict:
    """Gemini Visionã§å®¿é¡Œå•é¡Œã‚’èªè­˜"""
    import base64
    from google import genai

    # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
    image_bytes = base64.b64decode(image_data.split(',')[1])

    # Gemini Visionå‘¼ã³å‡ºã—
    client = genai.Client(api_key=os.getenv('GEMINI_API_KEY'))
    response = client.models.generate_content(
        model='gemini-2.0-flash-exp',
        contents=[
            VISION_PROMPT,
            {
                'inline_data': {
                    'mime_type': 'image/jpeg',
                    'data': base64.b64encode(image_bytes).decode()
                }
            }
        ]
    )

    # JSONè§£æ
    result = json.loads(response.text)
    return result
```

**UI/UXè¨­è¨ˆ**

| çŠ¶æ…‹ | è¡¨ç¤º | æ“ä½œ |
|------|------|------|
| **åˆæœŸçŠ¶æ…‹** | ã€ŒğŸ“· å†™çœŸã§å•é¡Œã‚’èªè­˜ã™ã‚‹ã€ãƒœã‚¿ãƒ³ | ãƒœã‚¿ãƒ³ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‚«ãƒ¡ãƒ©èµ·å‹• |
| **ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ãƒ†ã‚£ãƒ–** | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ + ã‚¬ã‚¤ãƒ‰ç·š | ã€Œæ’®å½±ã™ã‚‹ã€ãƒœã‚¿ãƒ³ |
| **ç”»åƒå‡¦ç†ä¸­** | ã‚¹ãƒ”ãƒŠãƒ¼ + ã€Œå•é¡Œã‚’èªè­˜ã—ã¦ã„ã¾ã™...ã€ | ï¼ˆå¾…æ©Ÿï¼‰ |
| **èªè­˜å®Œäº†** | èªè­˜ã—ãŸå•é¡Œæ–‡ + ç¢ºèª/æ’®ã‚Šç›´ã—ãƒœã‚¿ãƒ³ | ç¢ºèªã—ã¦å¯¾è©±é–‹å§‹ or æ’®ã‚Šç›´ã— |
| **èªè­˜ã‚¨ãƒ©ãƒ¼** | ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æ’®ã‚Šç›´ã—ãƒœã‚¿ãƒ³ | æ’®ã‚Šç›´ã— |

**ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**

```typescript
interface RecognitionError {
  type: 'camera_permission' | 'recognition_failed' | 'low_confidence' | 'network_error';
  message: string;
  suggestions: string[];
}

const ERROR_MESSAGES = {
  camera_permission: {
    message: 'ã‚«ãƒ¡ãƒ©ã®æ¨©é™ãŒå¿…è¦ã§ã™',
    suggestions: [
      'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„',
      'éŸ³å£°å…¥åŠ›ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã“ã¨ã‚‚ã§ãã¾ã™'
    ]
  },
  recognition_failed: {
    message: 'å•é¡Œã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ',
    suggestions: [
      'å•é¡Œå…¨ä½“ãŒå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„',
      'æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„',
      'æ‰‹æ›¸ãæ–‡å­—ã¯ã¯ã£ãã‚Šã¨æ›¸ã„ã¦ãã ã•ã„'
    ]
  },
  low_confidence: {
    message: 'å•é¡Œã®èªè­˜ã«è‡ªä¿¡ãŒã‚ã‚Šã¾ã›ã‚“',
    suggestions: [
      'èªè­˜ã—ãŸå†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„',
      'æ­£ã—ããªã„å ´åˆã¯æ’®ã‚Šç›´ã—ã¦ãã ã•ã„'
    ]
  },
  network_error: {
    message: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
    suggestions: [
      'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„',
      'ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ãã ã•ã„'
    ]
  }
};
```

**ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**

- **ç”»åƒåœ§ç¸®**: JPEGå“è³ª90%ã€æœ€å¤§1920x1080px
- **ãƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–å‡¦ç†**: ä½è§£åƒåº¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ â†’ é«˜ç²¾åº¦èªè­˜
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: åŒã˜ç”»åƒã®å†èªè­˜ã‚’é˜²æ­¢
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 10ç§’ä»¥å†…ã«å¿œç­”ãŒãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼

**ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**

- ã‚«ãƒ¡ãƒ©éå¯¾å¿œãƒ‡ãƒã‚¤ã‚¹ã§ã¯éŸ³å£°å…¥åŠ›ã®ã¿è¡¨ç¤º
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ä»£æ›¿æ‰‹æ®µã‚’æä¾›
- èªè­˜çµæœã®èª­ã¿ä¸Šã’æ©Ÿèƒ½

### 2.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹

#### 2.2.1 FirestoreSessionService
ADKã®SessionServiceã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…ã—ãŸFirestoreãƒ™ãƒ¼ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

**è²¬å‹™**
- ADK Sessionã®æ°¸ç¶šåŒ–ï¼ˆFirestoreï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å–å¾—ãƒ»ä½œæˆ
- å¯¾è©±å±¥æ­´ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä¿å­˜

**å®Ÿè£…**
```python
from google.adk.sessions import SessionService
from google.cloud import firestore

class FirestoreSessionService(SessionService):
    def __init__(self):
        self.db = firestore.AsyncClient()
        self.collection = "sessions"

    async def get_session(
        self, app_name: str, user_id: str, session_id: str
    ) -> Session | None:
        """Firestoreã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’å–å¾—"""
        doc_ref = self.db.collection(self.collection).document(session_id)
        doc = await doc_ref.get()

        if doc.exists:
            return Session.from_dict(doc.to_dict())
        return None

    async def create_session(
        self, app_name: str, user_id: str, session_id: str
    ) -> Session:
        """æ–°è¦ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’Firestoreã«ä½œæˆ"""
        session = Session(
            id=session_id,
            user_id=user_id,
            app_name=app_name,
            created_at=firestore.SERVER_TIMESTAMP
        )

        doc_ref = self.db.collection(self.collection).document(session_id)
        await doc_ref.set(session.to_dict())

        return session

    async def save_session(self, session: Session) -> None:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’Firestoreã«ä¿å­˜"""
        doc_ref = self.db.collection(self.collection).document(session.id)
        await doc_ref.update(session.to_dict())
```

**Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ **
```
sessions/{session_id}
  â”œâ”€ id: string
  â”œâ”€ user_id: string
  â”œâ”€ app_name: string
  â”œâ”€ created_at: timestamp
  â”œâ”€ updated_at: timestamp
  â”œâ”€ current_problem_id: string | null
  â”œâ”€ dialogue_history: array
  â”œâ”€ emotional_state: string
  â””â”€ hint_level: number
```

#### 2.2.2 BigQueryDataService
å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã®æ°¸ç¶šåŒ–ã¨ã‚¯ã‚¨ãƒª

**è²¬å‹™**
- ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã‚’BigQueryã«ä¿å­˜
- å­¦ç¿’é€²æ—ã®é›†è¨ˆãƒ»åˆ†æ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®ç¿’ç†Ÿåº¦ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ

**å®Ÿè£…**
```python
from google.cloud import bigquery
from datetime import datetime

class BigQueryDataService:
    def __init__(self):
        self.client = bigquery.Client()
        self.dataset_id = "homework_coach"

    async def save_session_data(self, session_data: dict) -> None:
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’BigQueryã«ä¿å­˜"""
        table_id = f"{self.dataset_id}.dialogue_sessions"

        rows_to_insert = [{
            "session_id": session_data["id"],
            "user_id": session_data["user_id"],
            "start_time": session_data["start_time"],
            "end_time": datetime.utcnow().isoformat(),
            "problems_attempted": session_data["problems"],
            "total_points": session_data["total_points"],
            "dialogue_turns": session_data["dialogue_history"],
            "created_at": datetime.utcnow()
        }]

        errors = self.client.insert_rows_json(table_id, rows_to_insert)
        if errors:
            raise Exception(f"BigQuery insert errors: {errors}")

    async def get_user_stats(self, user_id: str, days: int = 7) -> dict:
        """ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å­¦ç¿’çµ±è¨ˆã‚’å–å¾—"""
        query = f"""
            SELECT
                COUNT(DISTINCT session_id) as sessions_count,
                SUM(total_points) as total_points,
                AVG(
                    ARRAY_LENGTH(
                        JSON_EXTRACT_ARRAY(problems_attempted, '$')
                    )
                ) as avg_problems_per_session,
                SUM(
                    (SELECT COUNT(*)
                     FROM UNNEST(JSON_EXTRACT_ARRAY(problems_attempted, '$'))
                     WHERE JSON_EXTRACT_SCALAR(problem, '$.discovery_method') = 'self')
                ) as self_discovery_count
            FROM `{self.dataset_id}.dialogue_sessions`
            WHERE user_id = @user_id
                AND start_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL @days DAY)
        """

        job_config = bigquery.QueryJobConfig(
            query_parameters=[
                bigquery.ScalarQueryParameter("user_id", "STRING", user_id),
                bigquery.ScalarQueryParameter("days", "INT64", days),
            ]
        )

        results = self.client.query(query, job_config=job_config).result()
        return next(results)
```

#### 2.2.3 WebSocketHandler
WebSocketæ¥ç¶šã¨ADKçµ±åˆ

**è²¬å‹™**
- WebSocketæ¥ç¶šã®ç¢ºç«‹ã¨ç®¡ç†
- ä¸Šæµã‚¿ã‚¹ã‚¯ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ LiveRequestQueueï¼‰
- ä¸‹æµã‚¿ã‚¹ã‚¯ï¼ˆADK Events â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰

**å®Ÿè£…**
```python
from fastapi import WebSocket, WebSocketDisconnect
import asyncio

class WebSocketHandler:
    def __init__(self, runner: Runner, bigquery_service: BigQueryDataService):
        self.runner = runner
        self.bigquery_service = bigquery_service

    async def handle_connection(
        self,
        websocket: WebSocket,
        user_id: str,
        session_id: str,
        run_config: RunConfig
    ):
        """WebSocketæ¥ç¶šã‚’å‡¦ç†"""
        await websocket.accept()

        live_request_queue = LiveRequestQueue()

        try:
            # ä¸¦è¡Œã‚¿ã‚¹ã‚¯å®Ÿè¡Œ
            await asyncio.gather(
                self._upstream_task(websocket, live_request_queue),
                self._downstream_task(
                    websocket, user_id, session_id,
                    live_request_queue, run_config
                )
            )
        except WebSocketDisconnect:
            logger.info(f"Client disconnected: {session_id}")
        finally:
            live_request_queue.close()
            # ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«BigQueryã«ä¿å­˜
            await self._save_session_to_bigquery(session_id)

    async def _upstream_task(
        self, websocket: WebSocket, queue: LiveRequestQueue
    ):
        """éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚­ãƒ¥ãƒ¼ã«é€ä¿¡"""
        while True:
            message = await websocket.receive()

            if "bytes" in message:
                # PCMéŸ³å£°ãƒ‡ãƒ¼ã‚¿
                audio_blob = types.Blob(
                    mime_type="audio/pcm;rate=16000",
                    data=message["bytes"]
                )
                queue.send_realtime(audio_blob)
            elif "text" in message:
                # ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                json_msg = json.loads(message["text"])
                if json_msg.get("type") == "text":
                    content = types.Content(
                        parts=[types.Part(text=json_msg["text"])]
                    )
                    queue.send_content(content)

    async def _downstream_task(
        self,
        websocket: WebSocket,
        user_id: str,
        session_id: str,
        queue: LiveRequestQueue,
        run_config: RunConfig
    ):
        """ADKã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€ä¿¡"""
        async for event in self.runner.run_live(
            user_id=user_id,
            session_id=session_id,
            live_request_queue=queue,
            run_config=run_config
        ):
            event_json = event.model_dump_json(
                exclude_none=True, by_alias=True
            )
            await websocket.send_text(event_json)

    async def _save_session_to_bigquery(self, session_id: str):
        """ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã«BigQueryã«ä¿å­˜"""
        session = await self.session_service.get_session(
            app_name="homework-coach",
            user_id="",  # ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å–å¾—
            session_id=session_id
        )

        if session:
            await self.bigquery_service.save_session_data(
                session.to_dict()
            )
```

---

## 3. å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ

### 3.1 ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼å¯¾è©±ãƒãƒãƒ¼ã‚¸ãƒ£

#### 3.1.1 å¯¾è©±ãƒ•ãƒ­ãƒ¼

```
1. å•é¡Œèª­ã¿ä¸Šã’
   â†“
2. ç†è§£åº¦ç¢ºèª
   ã€Œã“ã®å•é¡Œã€ä½•ã‚’èã„ã¦ã‚‹ã¨æ€ã†ï¼Ÿã€
   â†“
3. å­ä¾›ã®å›ç­”ã‚’åˆ†æ
   â”œâ”€ æ­£ã—ã„ç†è§£ â†’ ã‚¹ãƒ†ãƒƒãƒ—4ã¸
   â””â”€ èª¤è§£ â†’ å•é¡Œã®å†ç¢ºèª
   â†“
4. æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã®èª˜å°
   ã€Œã˜ã‚ƒã‚ã€ã©ã†ã‚„ã£ã¦è§£ã‘ã‚‹ã¨æ€ã†ï¼Ÿã€
   â†“
5. éƒ¨åˆ†çš„ãªå›ç­”ã®è©•ä¾¡
   â”œâ”€ æ­£ã—ã„æ–¹å‘ â†’ åŠ±ã¾ã— + æ¬¡ã®è³ªå•
   â”œâ”€ ä¸€éƒ¨æ­£ã—ã„ â†’ è‰¯ã„ç‚¹ã‚’æŒ‡æ‘˜ + ä¿®æ­£ã®è³ªå•
   â””â”€ è¡Œãè©°ã¾ã‚Š â†’ ãƒ’ãƒ³ãƒˆæä¾›ã®ææ¡ˆ
   â†“
6. æœ€çµ‚å›ç­”
   â†“
7. ãƒ—ãƒ­ã‚»ã‚¹ã®æŒ¯ã‚Šè¿”ã‚Š
   ã€Œã©ã†ã‚„ã£ã¦æ°—ã¥ã„ãŸã®ï¼Ÿã€
```

#### 3.1.2 è³ªå•ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯

**å…¥åŠ›**
- ç¾åœ¨ã®å•é¡Œ
- å­ä¾›ã®å›ç­”
- å¯¾è©±å±¥æ­´
- å­ä¾›ã®ç†è§£åº¦ãƒ¬ãƒ™ãƒ«

**å‡ºåŠ›**
- æ¬¡ã®è³ªå•
- è³ªå•ã®ã‚¿ã‚¤ãƒ—ï¼ˆç†è§£ç¢ºèª/æ€è€ƒèª˜å°/ãƒ’ãƒ³ãƒˆï¼‰
- ãƒˆãƒ¼ãƒ³ï¼ˆåŠ±ã¾ã—/ä¸­ç«‹/å…±æ„Ÿï¼‰

**ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹**
```
ã‚ãªãŸã¯å°å­¦æ ¡ä½å­¦å¹´ã®å­ä¾›ã‚’å°ãå„ªã—ã„ã‚³ãƒ¼ãƒã§ã™ã€‚
å­ä¾›ãŒè‡ªåˆ†ã§ç­”ãˆã«æ°—ã¥ã‘ã‚‹ã‚ˆã†ã€è³ªå•ã§å°ã„ã¦ãã ã•ã„ã€‚
æ±ºã—ã¦ç­”ãˆã‚’ç›´æ¥æ•™ãˆãªã„ã§ãã ã•ã„ã€‚

ç¾åœ¨ã®å•é¡Œ: {problem}
å­ä¾›ã®å›ç­”: {child_response}
å¯¾è©±å±¥æ­´: {dialogue_history}

æ¬¡ã®è³ªå•ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚
è³ªå•ã®ã‚¿ã‚¤ãƒ—: {question_type}
ãƒˆãƒ¼ãƒ³: {tone}
```

### 3.2 ãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

#### 3.2.1 ãƒ’ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã®æ±ºå®šãƒ­ã‚¸ãƒƒã‚¯

```typescript
class HintSystem {
  determineHintLevel(context: DialogueContext): HintLevel {
    const {
      problemDifficulty,
      childFrustrationLevel,
      attemptsCount,
      timeElapsed
    } = context;

    // ãƒ•ãƒ©ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ â†’ ã‚ˆã‚Šå…·ä½“çš„ãªãƒ’ãƒ³ãƒˆ
    if (childFrustrationLevel > 7) {
      return HintLevel.LEVEL_3;
    }

    // è©¦è¡Œå›æ•°ãŒå¤šã„ â†’ ãƒ’ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«ã‚’ä¸Šã’ã‚‹
    if (attemptsCount > 3) {
      return HintLevel.LEVEL_2;
    }

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å•é¡Œç†è§£ã®ç¢ºèªã‹ã‚‰
    return HintLevel.LEVEL_1;
  }

  generateHint(level: HintLevel, problem: Problem): string {
    switch (level) {
      case HintLevel.LEVEL_1:
        return this.generateUnderstandingCheck(problem);
      case HintLevel.LEVEL_2:
        return this.generateRecallPrompt(problem);
      case HintLevel.LEVEL_3:
        return this.generatePartialSupport(problem);
    }
  }
}
```

#### 3.2.2 ãƒ’ãƒ³ãƒˆç”Ÿæˆä¾‹

**å•é¡Œä¾‹**: ã€Œã‚Šã‚“ã”ãŒ5ã“ã‚ã‚Šã¾ã—ãŸã€‚3ã“ãŸã¹ã¾ã—ãŸã€‚ã®ã“ã‚Šã¯ãªã‚“ã“ã§ã—ã‚‡ã†ï¼Ÿã€

**ãƒ¬ãƒ™ãƒ«1: å•é¡Œç†è§£ã®ç¢ºèª**
```
ã€Œã“ã®å•é¡Œã€ä½•ã«ã¤ã„ã¦èã„ã¦ã‚‹ã‹ãªï¼Ÿã€
â†’ ã€Œæœ€åˆã«ã‚Šã‚“ã”ã¯ä½•å€‹ã‚ã£ãŸã£ã¦è¨€ã£ã¦ãŸï¼Ÿã€
â†’ ã€Œãã®ã‚ã¨ã€ä½•å€‹é£Ÿã¹ãŸã‚“ã ã£ã‘ï¼Ÿã€
```

**ãƒ¬ãƒ™ãƒ«2: æ—¢ç¿’äº‹é …ã®æƒ³èµ·**
```
ã€Œå‰ã«ä¼¼ãŸã‚ˆã†ãªå•é¡Œã‚„ã£ãŸã‚ˆã­ï¼Ÿã€
â†’ ã€Œã€ã®ã“ã‚Šã¯ä½•å€‹ã€ã£ã¦èã‹ã‚ŒãŸã¨ãã€ã©ã†ã‚„ã£ã¦è¨ˆç®—ã—ãŸã£ã‘ï¼Ÿã€
â†’ ã€Œå¢—ãˆã‚‹ã®ã¨æ¸›ã‚‹ã®ã€ã©ã£ã¡ã ã¨æ€ã†ï¼Ÿã€
```

**ãƒ¬ãƒ™ãƒ«3: éƒ¨åˆ†çš„æ”¯æ´**
```
ã€Œã˜ã‚ƒã‚ã€æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã ã‘ä¸€ç·’ã«ã‚„ã‚ã†ã€
â†’ ã€Œæœ€åˆã«5å€‹ã‚ã£ã¦ã€3å€‹é£Ÿã¹ãŸã‚“ã ã‚ˆã­ã€
â†’ ã€Œ5ã‹ã‚‰3ã‚’å¼•ãã¨...ï¼Ÿã€
```

### 3.3 æ„Ÿæƒ…èªè­˜ã¨é©å¿œ

#### 3.3.1 æ„Ÿæƒ…çŠ¶æ…‹ã®æ¤œçŸ¥

**æ¤œçŸ¥é …ç›®**
- éŸ³å£°ã®ãƒ”ãƒƒãƒå¤‰åŒ–
- éŸ³é‡ã®å¤‰åŒ–
- ç™ºè©±é€Ÿåº¦
- æ²ˆé»™ã®é•·ã•
- è¨€è‘‰ã®ãƒˆãƒ¼ãƒ³ï¼ˆæ˜ã‚‹ã„/æš—ã„ï¼‰

**æ„Ÿæƒ…çŠ¶æ…‹ã®åˆ†é¡**
```typescript
enum EmotionalState {
  FRUSTRATED = 'frustrated',      // ã‚¤ãƒ©ã‚¤ãƒ©
  CONFUSED = 'confused',          // æ··ä¹±
  CONFIDENT = 'confident',        // è‡ªä¿¡ã‚ã‚Š
  TIRED = 'tired',                // ç–²ã‚Œã¦ã„ã‚‹
  EXCITED = 'excited',            // æ¥½ã—ã„
  NEUTRAL = 'neutral'             // ä¸­ç«‹
}
```

#### 3.3.2 é©å¿œãƒ­ã‚¸ãƒƒã‚¯

```typescript
class AdaptiveCoach {
  adaptToEmotion(emotion: EmotionalState, context: DialogueContext): Adaptation {
    switch (emotion) {
      case EmotionalState.FRUSTRATED:
        return {
          action: 'simplify',
          message: 'å¤§ä¸ˆå¤«ã€ã‚‚ã£ã¨ç°¡å˜ã«ã—ã¦ã¿ã‚ˆã†',
          hintLevel: 3,
          breakSuggestion: false
        };

      case EmotionalState.TIRED:
        return {
          action: 'encourage_break',
          message: 'ã¡ã‚‡ã£ã¨ä¼‘æ†©ã™ã‚‹ï¼Ÿæ°´é£²ã‚“ã§ãã¦ã‚‚ã„ã„ã‚ˆ',
          hintLevel: 2,
          breakSuggestion: true
        };

      case EmotionalState.CONFIDENT:
        return {
          action: 'challenge',
          message: 'èª¿å­ã„ã„ã­ï¼æ¬¡ã¯ã‚‚ã†ã¡ã‚‡ã£ã¨é›£ã—ã„ã®ã„ãï¼Ÿ',
          hintLevel: 0,
          breakSuggestion: false
        };

      default:
        return {
          action: 'continue',
          message: 'ã„ã„æ„Ÿã˜ï¼ã“ã®ã¾ã¾ç¶šã‘ã‚ˆã†',
          hintLevel: 1,
          breakSuggestion: false
        };
    }
  }
}
```

### 3.4 æ©Ÿèƒ½åˆ¥ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è©³ç´°

#### 3.4.1 éŸ³å£°å‡¦ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
sequenceDiagram
    participant C as ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
    participant WS as WebSocket
    participant ADK as ADK Runner
    participant Gemini as Gemini Live API
    participant STT as Cloud STT
    participant TTS as Cloud TTS

    Note over C,TTS: éŸ³å£°å…¥åŠ›ãƒ•ãƒ­ãƒ¼

    C->>C: ãƒã‚¤ã‚¯ã‹ã‚‰éŸ³å£°ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆPCM 16kHzï¼‰
    C->>WS: éŸ³å£°ãƒãƒ£ãƒ³ã‚¯é€ä¿¡ï¼ˆãƒã‚¤ãƒŠãƒªï¼‰
    WS->>ADK: LiveRequestQueue.send_realtime()
    ADK->>Gemini: éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆãƒªãƒ¼ãƒ 
    Gemini->>Gemini: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ éŸ³å£°èªè­˜

    alt Gemini Native Audioä½¿ç”¨
        Gemini->>Gemini: ãƒã‚¤ãƒ†ã‚£ãƒ–éŸ³å£°å‡¦ç†
        Gemini->>ADK: æ–‡å­—èµ·ã“ã—çµæœï¼ˆEventï¼‰
    else STT APIä½µç”¨
        ADK->>STT: éŸ³å£°ãƒ‡ãƒ¼ã‚¿
        STT->>ADK: æ–‡å­—èµ·ã“ã—çµæœ
    end

    ADK->>WS: transcript ã‚¤ãƒ™ãƒ³ãƒˆ
    WS->>C: æ–‡å­—èµ·ã“ã—è¡¨ç¤º

    Note over C,TTS: AIå¿œç­”ãƒ•ãƒ­ãƒ¼

    Gemini->>Gemini: ã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼è³ªå•ç”Ÿæˆ
    Gemini->>ADK: å¿œç­”ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆï¼ˆEventï¼‰

    alt Gemini Native Audioä½¿ç”¨
        Gemini->>ADK: éŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼ˆEventï¼‰
        ADK->>WS: response_audio ã‚¤ãƒ™ãƒ³ãƒˆ
        WS->>C: éŸ³å£°å†ç”Ÿ
    else TTS APIä½¿ç”¨
        ADK->>TTS: ãƒ†ã‚­ã‚¹ãƒˆâ†’éŸ³å£°å¤‰æ›
        TTS->>ADK: éŸ³å£°ãƒ‡ãƒ¼ã‚¿
        ADK->>WS: response_audio ã‚¤ãƒ™ãƒ³ãƒˆ
        WS->>C: éŸ³å£°å†ç”Ÿ
    end

    C->>C: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆSpeakingçŠ¶æ…‹ï¼‰
```

**éŸ³å£°å½¢å¼:**
- **å…¥åŠ›**: PCM, 16kHz, mono, 16-bit
- **å‡ºåŠ›**: PCM, 16kHz, mono, 16-bitï¼ˆGeminiï¼‰ã¾ãŸã¯ MP3ï¼ˆTTS APIï¼‰
- **ãƒãƒ£ãƒ³ã‚¯ã‚µã‚¤ã‚º**: 4KBæ¨å¥¨

**ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ç›®æ¨™:**
- éŸ³å£°èªè­˜: < 200ms
- è³ªå•ç”Ÿæˆ: < 1000ms
- éŸ³å£°åˆæˆ: < 300ms
- **åˆè¨ˆ**: < 1500ms

#### 3.4.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```mermaid
graph TB
    subgraph "ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«"
        S1[ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ]
        S2[ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œ]
        S3[ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€æ™‚åœæ­¢]
        S4[ã‚»ãƒƒã‚·ãƒ§ãƒ³å†é–‹]
        S5[ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†]
    end

    subgraph "çŠ¶æ…‹ç®¡ç†ï¼ˆFirestoreï¼‰"
        F1[Session Document]
        F2[Dialogue Turns]
        F3[Current Problem]
    end

    subgraph "æ°¸ç¶šåŒ–ï¼ˆBigQueryï¼‰"
        B1[dialogue_sessions]
        B2[problem_attempts]
        B3[dialogue_turns]
    end

    S1 -->|ä½œæˆ| F1
    S2 -->|ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°| F1
    S2 -->|è¿½åŠ | F2
    S2 -->|æ›´æ–°| F3

    S3 -->|ä¿å­˜| F1
    S4 -->|å¾©å…ƒ| F1
    S4 -->|å¾©å…ƒ| F2

    S5 -->|æœ€çµ‚ä¿å­˜| F1
    S5 -->|è»¢é€| B1
    S5 -->|è»¢é€| B2
    S5 -->|è»¢é€| B3
    S5 -->|å‰Šé™¤| F2

    style S1 fill:#e1f5ff
    style S5 fill:#ffebee
```

**ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹é·ç§»:**

1. **ä½œæˆ** â†’ Firestoreã«æ–°è¦ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ
2. **é€²è¡Œä¸­** â†’ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§çŠ¶æ…‹æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
3. **ä¸€æ™‚åœæ­¢** â†’ ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜ã€WebSocketåˆ‡æ–­
4. **å†é–‹** â†’ Firestoreã‹ã‚‰çŠ¶æ…‹å¾©å…ƒã€WebSocketå†æ¥ç¶š
5. **çµ‚äº†** â†’ BigQueryã«å…¨ãƒ‡ãƒ¼ã‚¿è»¢é€ã€Firestoreã‹ã‚‰å¯¾è©±å±¥æ­´å‰Šé™¤

#### 3.4.3 å­¦ç¿’ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant S as Session
    participant FS as Firestore
    participant BQ as BigQuery
    participant Cache as Redis

    Note over S,Cache: ã‚»ãƒƒã‚·ãƒ§ãƒ³é€²è¡Œä¸­

    S->>FS: çŠ¶æ…‹æ›´æ–°ï¼ˆ1ç§’ã”ã¨ï¼‰
    S->>FS: å¯¾è©±ã‚¿ãƒ¼ãƒ³è¿½åŠ 
    S->>Cache: ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã‚­ãƒ£ãƒƒã‚·ãƒ¥

    Note over S,Cache: ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚

    S->>FS: æœ€çµ‚çŠ¶æ…‹ä¿å­˜
    S->>BQ: dialogue_sessionsæŒ¿å…¥
    S->>BQ: problem_attemptsæŒ¿å…¥
    S->>BQ: dialogue_turnsæŒ¿å…¥

    BQ->>BQ: ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ä½œæˆï¼ˆæ—¥ä»˜ï¼‰
    BQ->>BQ: ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ï¼ˆuser_idï¼‰

    S->>FS: å¯¾è©±å±¥æ­´å‰Šé™¤ï¼ˆdialogue_turnsï¼‰
    S->>FS: ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹æ›´æ–°ï¼ˆisActive: falseï¼‰

    Note over S,Cache: çµ±è¨ˆé›†è¨ˆï¼ˆéåŒæœŸï¼‰

    BQ->>BQ: é€±æ¬¡çµ±è¨ˆã‚¯ã‚¨ãƒªå®Ÿè¡Œ
    BQ->>FS: çµ±è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ï¼ˆuser.statsï¼‰
```

**ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“:**

| ãƒ‡ãƒ¼ã‚¿ç¨®åˆ¥ | Firestore | BigQuery | ç†ç”± |
|-----------|-----------|----------|------|
| ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ | æ°¸ç¶š | æ°¸ç¶š | ã‚»ãƒƒã‚·ãƒ§ãƒ³å±¥æ­´ã¨ã—ã¦ä¿æŒ |
| å¯¾è©±ã‚¿ãƒ¼ãƒ³ | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã®ã¿ | æ°¸ç¶š | åˆ†æç”¨ã«æ°¸ä¹…ä¿å­˜ |
| éŸ³å£°ãƒ‡ãƒ¼ã‚¿ | ä¿å­˜ã—ãªã„ | ä¿å­˜ã—ãªã„ | ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­· |
| çµ±è¨ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ | æ°¸ç¶š | ã‚½ãƒ¼ã‚¹ | BigQueryã§é›†è¨ˆâ†’Firestore |

#### 3.4.4 ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆPhase 2ï¼‰

```mermaid
graph LR
    subgraph "ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ "
        P1[è‡ªåˆ†ã§æ°—ã¥ã„ãŸ: 3pt]
        P2[ãƒ’ãƒ³ãƒˆLv1: 2pt]
        P3[ãƒ’ãƒ³ãƒˆLv2: 1pt]
        P4[ä¸€ç·’ã«è§£ã„ãŸ: 1pt]
    end

    subgraph "ç§°å·ã‚·ã‚¹ãƒ†ãƒ "
        A1[é€£ç¶š5æ—¥é”æˆ]
        A2[è‡ªåŠ›è§£ç­”50å•]
        A3[é›£å•ã‚¯ãƒªã‚¢]
    end

    subgraph "ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œ"
        Q1[ã‚¯ã‚¨ã‚¹ãƒˆ1: ç®—æ•°ã®æ£®]
        Q2[ã‚¯ã‚¨ã‚¹ãƒˆ2: å›½èªã®æµ·]
        Q3[ã‚¯ã‚¨ã‚¹ãƒˆ3: ç†ç§‘ã®å±±]
    end

    P1 --> Points[ç·ãƒã‚¤ãƒ³ãƒˆ]
    P2 --> Points
    P3 --> Points
    P4 --> Points

    Points --> A1
    Points --> A2
    Points --> A3

    A1 --> Rewards[å ±é…¬ã‚¢ãƒ³ãƒ­ãƒƒã‚¯]
    A2 --> Rewards
    A3 --> Rewards

    Points --> Q1
    Q1 --> Q2
    Q2 --> Q3

    style Points fill:#fff9c4
    style Rewards fill:#f3e5f5
```

**å®Ÿè£…å„ªå…ˆåº¦:**
- Phase 1: ãƒã‚¤ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 
- Phase 2: ç§°å·ã‚·ã‚¹ãƒ†ãƒ ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼é€²è¡Œ
- Phase 3: ãƒãƒ«ãƒãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼è¦ç´ 

---

## 4. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 4.0 ERå›³ï¼ˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é–¢ä¿‚å›³ï¼‰

```mermaid
erDiagram
    USER ||--o{ SESSION : "has"
    USER ||--o{ NOTIFICATION : "receives"
    USER {
        string id PK
        string name
        int gradeLevel
        timestamp createdAt
        json settings
        string currentSessionId FK
    }

    SESSION ||--o{ PROBLEM_ATTEMPT : "contains"
    SESSION {
        string id PK
        string userId FK
        string appName
        timestamp createdAt
        timestamp updatedAt
        boolean isActive
        string currentProblemId FK
        int hintLevel
        string emotionalState
    }

    PROBLEM ||--o{ PROBLEM_ATTEMPT : "used_in"
    PROBLEM {
        string id PK
        string subject
        int gradeLevel
        int difficulty
        string questionText
        string correctAnswer
        array relatedConcepts
        json hints
    }

    PROBLEM_ATTEMPT ||--o{ DIALOGUE_TURN : "has"
    PROBLEM_ATTEMPT {
        string attemptId PK
        string sessionId FK
        string problemId FK
        timestamp startTime
        timestamp endTime
        boolean solved
        int hintsUsed
        int attemptsCount
        string discoveryMethod
        int pointsEarned
    }

    DIALOGUE_TURN {
        string turnId PK
        string sessionId FK
        string speaker
        timestamp timestamp
        string transcript
        string emotion
        string questionType
    }

    NOTIFICATION {
        string id PK
        string userId FK
        string type
        string message
        timestamp createdAt
        boolean read
    }

    LEARNING_HISTORY ||--|| USER : "belongs_to"
    LEARNING_HISTORY {
        string userId FK
        array weeklyStats
        array conceptMastery
        array achievements
    }

    ACHIEVEMENT {
        string id PK
        string name
        string description
        timestamp earnedAt
        string icon
    }

    USER ||--o{ LEARNING_HISTORY : "has"
    LEARNING_HISTORY ||--o{ ACHIEVEMENT : "contains"
```

**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é…ç½®:**

| ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ | Firestore | BigQuery | ç†ç”± |
|------------|-----------|----------|------|
| USER | âœ… ãƒ¡ã‚¤ãƒ³ | âŒ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¯ã‚»ã‚¹å¿…è¦ |
| SESSION | âœ… é€²è¡Œä¸­ | âœ… å®Œäº†å¾Œ | é€²è¡Œä¸­ã¯Firestoreã€å®Œäº†å¾ŒBigQuery |
| PROBLEM | âœ… ãƒ¡ã‚¤ãƒ³ | âŒ | å³æ™‚å‚ç…§ãŒå¿…è¦ |
| PROBLEM_ATTEMPT | âŒ | âœ… ãƒ¡ã‚¤ãƒ³ | åˆ†æç”¨ãƒ‡ãƒ¼ã‚¿ |
| DIALOGUE_TURN | âœ… ä¸€æ™‚ | âœ… æ°¸ä¹… | ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸­ã¯Firestoreã€çµ‚äº†å¾ŒBigQuery |
| NOTIFICATION | âœ… ãƒ¡ã‚¤ãƒ³ | âŒ | ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šçŸ¥ |
| LEARNING_HISTORY | âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ | âœ… ã‚½ãƒ¼ã‚¹ | BigQueryã§é›†è¨ˆâ†’Firestoreã‚­ãƒ£ãƒƒã‚·ãƒ¥ |
| ACHIEVEMENT | âœ… ãƒ¡ã‚¤ãƒ³ | âŒ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã®ä¸€éƒ¨ |

### 4.1 ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£

```typescript
interface User {
  id: string;
  name: string;
  gradeLevel: 1 | 2 | 3;
  createdAt: Date;
  settings: UserSettings;
}

interface UserSettings {
  preferredCharacter: CharacterType;
  voiceSpeed: number;
  volumeLevel: number;
  parentEmail?: string;
}

type CharacterType = 'robot' | 'wizard' | 'astronaut' | 'animal';
```

### 4.2 ã‚»ãƒƒã‚·ãƒ§ãƒ³é–¢é€£

```typescript
interface DialogueSession {
  id: string;
  userId: string;
  startTime: Date;
  endTime?: Date;
  problems: ProblemAttempt[];
  totalPoints: number;
  emotionalTimeline: EmotionalStateRecord[];
}

interface ProblemAttempt {
  problemId: string;
  startTime: Date;
  endTime?: Date;
  solved: boolean;
  hintsUsed: number;
  attemptsCount: number;
  discoveryMethod: 'self' | 'hint_level_1' | 'hint_level_2' | 'hint_level_3';
  pointsEarned: number;
  dialogueHistory: DialogueTurn[];
}

interface DialogueTurn {
  speaker: 'child' | 'coach';
  timestamp: Date;
  audioUrl?: string;
  transcript: string;
  emotion?: EmotionalState;
  questionType?: QuestionType;
}

type QuestionType =
  | 'understanding_check'
  | 'thinking_prompt'
  | 'recall_prompt'
  | 'hint'
  | 'encouragement';
```

### 4.3 å•é¡Œãƒ‡ãƒ¼ã‚¿

```typescript
interface Problem {
  id: string;
  subject: 'math' | 'japanese';
  gradeLevel: 1 | 2 | 3;
  difficulty: 1 | 2 | 3 | 4 | 5;
  questionText: string;
  correctAnswer: string;
  relatedConcepts: string[];
  commonMistakes: string[];
  hints: HintSet;
}

interface HintSet {
  level1: string[];  // å•é¡Œç†è§£ã®ç¢ºèª
  level2: string[];  // æ—¢ç¿’äº‹é …ã®æƒ³èµ·
  level3: string[];  // éƒ¨åˆ†çš„æ”¯æ´
}
```

### 4.4 å­¦ç¿’å±¥æ­´

```typescript
interface LearningHistory {
  userId: string;
  weeklyStats: WeeklyStat[];
  conceptMastery: ConceptMastery[];
  achievements: Achievement[];
}

interface WeeklyStat {
  weekStart: Date;
  problemsSolved: number;
  selfDiscoveryCount: number;
  hintsUsedTotal: number;
  totalPoints: number;
  timeSpent: number; // minutes
}

interface ConceptMastery {
  concept: string;
  attemptsCount: number;
  successRate: number;
  lastPracticed: Date;
  masteryLevel: 'beginner' | 'intermediate' | 'advanced';
}

interface Achievement {
  id: string;
  name: string;
  description: string;
  earnedAt: Date;
  icon: string;
}
```

### 4.5 BigQueryãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚­ãƒ¼ãƒ

#### 4.5.1 dialogue_sessions ãƒ†ãƒ¼ãƒ–ãƒ«
å­¦ç¿’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®å±¥æ­´ãƒ‡ãƒ¼ã‚¿

```sql
CREATE TABLE homework_coach.dialogue_sessions (
  session_id STRING NOT NULL,
  user_id STRING NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  total_points INT64,
  problems_attempted JSON,  -- ProblemAttempt[]ã®JSONé…åˆ—
  dialogue_turns JSON,       -- DialogueTurn[]ã®JSONé…åˆ—
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP()
)
PARTITION BY DATE(start_time)
CLUSTER BY user_id, start_time;
```

**ã‚¯ã‚¨ãƒªä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€±æ¬¡çµ±è¨ˆ**
```sql
SELECT
  user_id,
  COUNT(DISTINCT session_id) as sessions_count,
  SUM(total_points) as total_points,
  AVG(ARRAY_LENGTH(JSON_EXTRACT_ARRAY(problems_attempted, '$'))) as avg_problems,
  SUM(
    (SELECT COUNT(*)
     FROM UNNEST(JSON_EXTRACT_ARRAY(problems_attempted, '$')) problem
     WHERE JSON_EXTRACT_SCALAR(problem, '$.discovery_method') = 'self')
  ) as self_discovery_count
FROM homework_coach.dialogue_sessions
WHERE user_id = @user_id
  AND start_time >= TIMESTAMP_SUB(CURRENT_TIMESTAMP(), INTERVAL 7 DAY)
GROUP BY user_id;
```

#### 4.5.2 problem_attempts ãƒ†ãƒ¼ãƒ–ãƒ«
å€‹åˆ¥ã®å•é¡Œè§£ç­”å±¥æ­´ï¼ˆåˆ†æç”¨ï¼‰

```sql
CREATE TABLE homework_coach.problem_attempts (
  attempt_id STRING NOT NULL,
  session_id STRING NOT NULL,
  user_id STRING NOT NULL,
  problem_id STRING NOT NULL,
  subject STRING NOT NULL,  -- 'math' | 'japanese'
  grade_level INT64 NOT NULL,
  difficulty INT64 NOT NULL,
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP,
  solved BOOLEAN,
  hints_used INT64,
  attempts_count INT64,
  discovery_method STRING,  -- 'self' | 'hint_level_1' | 'hint_level_2' | 'hint_level_3'
  points_earned INT64,
  time_spent_seconds INT64,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP()
)
PARTITION BY DATE(start_time)
CLUSTER BY user_id, problem_id, start_time;
```

**ã‚¯ã‚¨ãƒªä¾‹: æ¦‚å¿µåˆ¥ã®ç¿’ç†Ÿåº¦**
```sql
WITH problem_concepts AS (
  SELECT
    pa.user_id,
    p.concept,
    pa.solved,
    pa.discovery_method
  FROM homework_coach.problem_attempts pa
  JOIN homework_coach.problems p ON pa.problem_id = p.id
  WHERE pa.user_id = @user_id
)
SELECT
  concept,
  COUNT(*) as attempts_count,
  COUNTIF(solved) / COUNT(*) as success_rate,
  COUNTIF(discovery_method = 'self') / COUNTIF(solved) as self_discovery_rate,
  MAX(start_time) as last_practiced
FROM problem_concepts
GROUP BY concept
ORDER BY success_rate DESC;
```

#### 4.5.3 dialogue_turns ãƒ†ãƒ¼ãƒ–ãƒ«
å¯¾è©±ã®è©³ç´°å±¥æ­´ï¼ˆæ©Ÿæ¢°å­¦ç¿’ç”¨ï¼‰

```sql
CREATE TABLE homework_coach.dialogue_turns (
  turn_id STRING NOT NULL,
  session_id STRING NOT NULL,
  user_id STRING NOT NULL,
  problem_id STRING,
  speaker STRING NOT NULL,  -- 'child' | 'coach'
  timestamp TIMESTAMP NOT NULL,
  transcript STRING,
  emotion STRING,           -- æ„Ÿæƒ…çŠ¶æ…‹
  question_type STRING,     -- è³ªå•ã‚¿ã‚¤ãƒ—
  audio_duration_ms INT64,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP()
)
PARTITION BY DATE(timestamp)
CLUSTER BY user_id, session_id, timestamp;
```

**ã‚¯ã‚¨ãƒªä¾‹: æ„Ÿæƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ**
```sql
SELECT
  emotion,
  COUNT(*) as count,
  AVG(
    TIMESTAMP_DIFF(
      LEAD(timestamp) OVER (PARTITION BY session_id ORDER BY timestamp),
      timestamp,
      SECOND
    )
  ) as avg_duration_seconds
FROM homework_coach.dialogue_turns
WHERE user_id = @user_id
  AND speaker = 'child'
  AND emotion IS NOT NULL
GROUP BY emotion;
```

#### 4.5.4 Firestoreãƒ‡ãƒ¼ã‚¿æ§‹é€ ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ï¼‰

**users ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**
```
users/{user_id}
  â”œâ”€ name: string
  â”œâ”€ gradeLevel: number (1-3)
  â”œâ”€ createdAt: timestamp
  â”œâ”€ settings: map
  â”‚   â”œâ”€ preferredCharacter: string
  â”‚   â”œâ”€ voiceSpeed: number
  â”‚   â”œâ”€ volumeLevel: number
  â”‚   â””â”€ parentEmail: string
  â””â”€ stats: map (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸçµ±è¨ˆ)
      â”œâ”€ totalPoints: number
      â”œâ”€ problemsSolved: number
      â””â”€ lastSessionAt: timestamp
```

**sessions ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**
```
sessions/{session_id}
  â”œâ”€ id: string
  â”œâ”€ userId: string
  â”œâ”€ appName: string
  â”œâ”€ createdAt: timestamp
  â”œâ”€ updatedAt: timestamp
  â”œâ”€ currentProblemId: string | null
  â”œâ”€ dialogueHistory: array
  â”œâ”€ emotionalState: string
  â”œâ”€ hintLevel: number
  â””â”€ isActive: boolean
```

**problems ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³**
```
problems/{problem_id}
  â”œâ”€ id: string
  â”œâ”€ subject: string ('math' | 'japanese')
  â”œâ”€ gradeLevel: number (1-3)
  â”œâ”€ difficulty: number (1-5)
  â”œâ”€ questionText: string
  â”œâ”€ correctAnswer: string
  â”œâ”€ relatedConcepts: array<string>
  â”œâ”€ commonMistakes: array<string>
  â””â”€ hints: map
      â”œâ”€ level1: array<string>
      â”œâ”€ level2: array<string>
      â””â”€ level3: array<string>
```

---

## 5. APIè¨­è¨ˆ

### 5.1 REST API

#### 5.1.1 èªè¨¼

```
POST /api/auth/register
POST /api/auth/login
POST /api/auth/logout
GET  /api/auth/me
```

#### 5.1.2 ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†

```
GET    /api/users/:userId
PUT    /api/users/:userId
GET    /api/users/:userId/settings
PUT    /api/users/:userId/settings
```

#### 5.1.3 ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†

```
POST   /api/sessions              # ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
GET    /api/sessions/:sessionId   # ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾—
PUT    /api/sessions/:sessionId   # ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°
DELETE /api/sessions/:sessionId   # ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†
```

#### 5.1.4 å­¦ç¿’å±¥æ­´

```
GET /api/users/:userId/history           # å…¨å±¥æ­´
GET /api/users/:userId/history/weekly    # é€±æ¬¡çµ±è¨ˆ
GET /api/users/:userId/history/concepts  # æ¦‚å¿µåˆ¥ç¿’ç†Ÿåº¦
GET /api/users/:userId/achievements      # ç²å¾—ã—ãŸç§°å·
```

#### 5.1.5 å•é¡Œç®¡ç†

```
GET /api/problems?grade=1&subject=math   # å•é¡Œå–å¾—
GET /api/problems/:problemId             # å•é¡Œè©³ç´°
```

#### 5.1.6 ç”»åƒèªè­˜ï¼ˆVision APIï¼‰

```
POST /api/vision/recognize               # ç”»åƒã‹ã‚‰å•é¡Œã‚’èªè­˜
```

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**
```typescript
{
  image: string,              // Base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿
  recognitionType: 'homework_problem' | 'handwriting' | 'diagram'
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆæˆåŠŸæ™‚ï¼‰**
```typescript
{
  success: true,
  problemText: string,        // èªè­˜ã•ã‚ŒãŸå•é¡Œæ–‡
  problemType: 'math' | 'reading' | 'writing',
  equations?: string[],       // æ•°å¼ï¼ˆLaTeXå½¢å¼ï¼‰
  hasDiagrams: boolean,       // å›³å½¢ãƒ»å›³è¡¨ã®æœ‰ç„¡
  confidence: number,         // èªè­˜ç²¾åº¦ï¼ˆ0.0-1.0ï¼‰
  metadata: {
    processingTime: number,   // å‡¦ç†æ™‚é–“ï¼ˆmsï¼‰
    imageSize: {
      width: number,
      height: number
    }
  }
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰**
```typescript
{
  success: false,
  error: {
    type: 'recognition_failed' | 'low_confidence' | 'invalid_image',
    message: string,
    suggestions: string[]
  }
}
```

**å®Ÿè£…ä¾‹ï¼ˆFastAPIï¼‰**

```python
from fastapi import APIRouter, HTTPException
from pydantic import BaseModel
import base64
from google import genai

router = APIRouter()

class VisionRequest(BaseModel):
    image: str
    recognitionType: str = 'homework_problem'

@router.post("/api/vision/recognize")
async def recognize_image(request: VisionRequest):
    """ç”»åƒã‹ã‚‰å®¿é¡Œå•é¡Œã‚’èªè­˜"""
    try:
        # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰
        if ',' in request.image:
            image_data = request.image.split(',')[1]
        else:
            image_data = request.image

        image_bytes = base64.b64decode(image_data)

        # Gemini Visionå‘¼ã³å‡ºã—
        result = await recognize_homework_problem(image_bytes)

        # ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã¯è­¦å‘Š
        if result['confidence'] < 0.7:
            return {
                "success": False,
                "error": {
                    "type": "low_confidence",
                    "message": "å•é¡Œã®èªè­˜ã«è‡ªä¿¡ãŒã‚ã‚Šã¾ã›ã‚“",
                    "suggestions": [
                        "æ˜ã‚‹ã„å ´æ‰€ã§æ’®å½±ã—ã¦ãã ã•ã„",
                        "å•é¡Œå…¨ä½“ãŒå†™ã‚‹ã‚ˆã†ã«æ’®å½±ã—ã¦ãã ã•ã„",
                        "æ‰‹æ›¸ãæ–‡å­—ã¯ã¯ã£ãã‚Šã¨æ›¸ã„ã¦ãã ã•ã„"
                    ]
                }
            }

        return {
            "success": True,
            **result
        }

    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail={
                "success": False,
                "error": {
                    "type": "recognition_failed",
                    "message": "ç”»åƒèªè­˜ã«å¤±æ•—ã—ã¾ã—ãŸ",
                    "suggestions": ["ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„"]
                }
            }
        )
```

### 5.2 WebSocket API

#### 5.2.1 æ¥ç¶š

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼
{
  type: 'connect',
  payload: {
    userId: string,
    sessionId: string
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
{
  type: 'connected',
  payload: {
    sessionId: string,
    character: CharacterType
  }
}
```

#### 5.2.2 éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ 

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼ˆéŸ³å£°ãƒ‡ãƒ¼ã‚¿ï¼‰
{
  type: 'audio_chunk',
  payload: {
    audioData: ArrayBuffer,
    timestamp: number
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆéŸ³å£°æ–‡å­—èµ·ã“ã—ï¼‰
{
  type: 'transcript',
  payload: {
    text: string,
    isFinal: boolean
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆå¿œç­”éŸ³å£°ï¼‰
{
  type: 'response_audio',
  payload: {
    audioUrl: string,
    transcript: string,
    emotion: EmotionalState
  }
}
```

#### 5.2.3 å¯¾è©±ã‚¤ãƒ™ãƒ³ãƒˆ

```typescript
// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆè³ªå•ç”Ÿæˆï¼‰
{
  type: 'coach_question',
  payload: {
    text: string,
    questionType: QuestionType,
    audioUrl: string
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒ’ãƒ³ãƒˆæä¾›ï¼‰
{
  type: 'hint_offered',
  payload: {
    level: HintLevel,
    isAvailable: boolean
  }
}

// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼ˆãƒ’ãƒ³ãƒˆè¦æ±‚ï¼‰
{
  type: 'request_hint',
  payload: {
    problemId: string
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆãƒã‚¤ãƒ³ãƒˆç²å¾—ï¼‰
{
  type: 'points_earned',
  payload: {
    points: number,
    reason: string,
    totalPoints: number
  }
}
```

#### 5.2.4 æ„Ÿæƒ…çŠ¶æ…‹

```typescript
// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆæ„Ÿæƒ…æ¤œçŸ¥ï¼‰
{
  type: 'emotion_detected',
  payload: {
    emotion: EmotionalState,
    confidence: number
  }
}
```

#### 5.2.5 ç”»åƒèªè­˜ã‚¤ãƒ™ãƒ³ãƒˆ

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ â†’ ã‚µãƒ¼ãƒãƒ¼ï¼ˆå†™çœŸã§å•é¡Œé–‹å§‹ï¼‰
{
  type: 'start_with_image',
  payload: {
    problemText: string,
    problemType: 'math' | 'reading' | 'writing',
    imageUrl?: string,        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³: ç”»åƒã®ä¿å­˜URL
    metadata: {
      equations?: string[],
      hasDiagrams: boolean,
      confidence: number
    }
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆç”»åƒèªè­˜ç¢ºèªï¼‰
{
  type: 'image_problem_confirmed',
  payload: {
    problemId: string,
    coachResponse: string,     // ã€Œã§ã¯ã€ã“ã®å•é¡Œã‚’ä¸€ç·’ã«è€ƒãˆã¦ã¿ã‚ˆã†ï¼ã€
    audioUrl: string
  }
}

// ã‚µãƒ¼ãƒãƒ¼ â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼ˆç”»åƒèªè­˜ã‚¨ãƒ©ãƒ¼ï¼‰
{
  type: 'image_recognition_error',
  payload: {
    error: string,
    suggestions: string[]
  }
}
```

**ç”»åƒèªè­˜ãƒ•ãƒ­ãƒ¼**

```
1. å­ä¾›ãŒå†™çœŸã‚’æ’®å½±
   â†“
2. CameraInterface â†’ POST /api/vision/recognize
   â†“
3. Gemini Vision ãŒå•é¡Œæ–‡ã‚’èªè­˜
   â†“
4. èªè­˜çµæœã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¡¨ç¤º
   â†“
5. å­ä¾›ãŒã€Œã“ã®å•é¡Œã§å§‹ã‚ã‚‹ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
   â†“
6. WebSocket: 'start_with_image' ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
   â†“
7. ã‚µãƒ¼ãƒãƒ¼ãŒå•é¡Œã‚’PROBLEMãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜
   â†“
8. ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ 'image_problem_confirmed' è¿”å´
   â†“
9. é€šå¸¸ã®å¯¾è©±ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
```

---

## 6. å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

### 6.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹ãƒ•ãƒ­ãƒ¼

```
1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: POST /api/sessions
   â†“
2. ã‚µãƒ¼ãƒãƒ¼: ã‚»ãƒƒã‚·ãƒ§ãƒ³ç”Ÿæˆ
   â†“
3. ã‚µãƒ¼ãƒãƒ¼: WebSocketæ¥ç¶šURLè¿”å´
   â†“
4. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: WebSocketæ¥ç¶š
   â†“
5. ã‚µãƒ¼ãƒãƒ¼: 'connected' ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
   â†“
6. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¡¨ç¤º
   â†“
7. ã‚µãƒ¼ãƒãƒ¼: ã€Œä»Šæ—¥ã¯ä½•ã®å®¿é¡Œï¼Ÿã€ï¼ˆéŸ³å£°ï¼‰
```

### 6.2 å•é¡Œè§£ç­”ãƒ•ãƒ­ãƒ¼

```
1. å­ä¾›: å•é¡Œã‚’èª­ã¿ä¸Šã’ã‚‹
   â†“
2. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: éŸ³å£°ãƒ‡ãƒ¼ã‚¿é€ä¿¡
   â†“
3. ã‚µãƒ¼ãƒãƒ¼: STT â†’ ãƒ†ã‚­ã‚¹ãƒˆåŒ–
   â†“
4. å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³: å•é¡Œã‚’èªè­˜
   â†“
5. å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³: ç†è§£åº¦ç¢ºèªè³ªå•ç”Ÿæˆ
   â†“
6. TTS: éŸ³å£°åˆæˆ
   â†“
7. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ: éŸ³å£°å†ç”Ÿ + ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
   â†“
8. å­ä¾›: å›ç­”
   â†“
9. ã‚µãƒ¼ãƒãƒ¼: å›ç­”åˆ†æ
   â”œâ”€ æ­£ã—ã„ â†’ æ¬¡ã®è³ªå•
   â”œâ”€ ä¸€éƒ¨æ­£ã—ã„ â†’ è‰¯ã„ç‚¹ã‚’æŒ‡æ‘˜ + ä¿®æ­£è³ªå•
   â””â”€ è¡Œãè©°ã¾ã‚Š â†’ ãƒ’ãƒ³ãƒˆææ¡ˆ
   â†“
10. (ãƒ’ãƒ³ãƒˆè¦æ±‚ãŒã‚ã‚Œã°)
    â”œâ”€ ãƒ’ãƒ³ãƒˆãƒ¬ãƒ™ãƒ«æ±ºå®š
    â”œâ”€ ãƒ’ãƒ³ãƒˆç”Ÿæˆ
    â””â”€ å®ç®±ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ + ãƒ’ãƒ³ãƒˆè¡¨ç¤º
   â†“
11. æœ€çµ‚å›ç­”
    â†“
12. ãƒ—ãƒ­ã‚»ã‚¹è©•ä¾¡ + ãƒã‚¤ãƒ³ãƒˆä»˜ä¸
    â†“
13. æŒ¯ã‚Šè¿”ã‚Šè³ªå•
```

### 6.3 æ„Ÿæƒ…é©å¿œãƒ•ãƒ­ãƒ¼

```
ä¸¦è¡Œå‡¦ç†:

[éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒ ]
   â†“
[æ„Ÿæƒ…èªè­˜ã‚µãƒ¼ãƒ“ã‚¹]
   â†“
[æ„Ÿæƒ…çŠ¶æ…‹æ›´æ–°]
   â†“
[é©å¿œãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œ]
   â”œâ”€ frustrated â†’ ç°¡å˜ãªã‚¹ãƒ†ãƒƒãƒ—ã«åˆ†è§£
   â”œâ”€ tired â†’ ä¼‘æ†©ææ¡ˆ
   â”œâ”€ confident â†’ å°‘ã—é›£æ˜“åº¦ã‚¢ãƒƒãƒ—
   â””â”€ excited â†’ è¤’ã‚ã‚‹ + ç¶™ç¶š
   â†“
[å¯¾è©±ç”Ÿæˆã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯]
```

---

## 7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 7.1 éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼

```typescript
class STTErrorHandler {
  handleError(error: STTError): RecoveryAction {
    switch (error.type) {
      case 'low_confidence':
        return {
          action: 'ask_repeat',
          message: 'ã”ã‚ã‚“ã€ã‚‚ã†ä¸€å›è¨€ã£ã¦ãã‚Œã‚‹ï¼Ÿ'
        };

      case 'background_noise':
        return {
          action: 'suggest_quiet',
          message: 'å‘¨ã‚ŠãŒã¡ã‚‡ã£ã¨ã†ã‚‹ã•ã„ã‹ãªã€‚é™ã‹ãªã¨ã“ã‚ã§ã‚„ã‚ã†'
        };

      case 'unclear_speech':
        return {
          action: 'simplify_question',
          message: 'ã‚†ã£ãã‚Šè©±ã—ã¦ãã‚Œã‚‹ï¼Ÿ'
        };

      default:
        return {
          action: 'fallback',
          message: 'èã“ãˆãªã‹ã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ä¸€å›ãŠé¡˜ã„'
        };
    }
  }
}
```

### 7.2 ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼

```typescript
class NetworkErrorHandler {
  handleDisconnection(): void {
    // 1. ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ä¿å­˜
    this.saveSessionLocally();

    // 2. å†æ¥ç¶šã‚’è©¦ã¿ã‚‹
    this.attemptReconnection();

    // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
    this.showNotification('æ¥ç¶šãŒåˆ‡ã‚Œã¡ã‚ƒã£ãŸã€‚å†æ¥ç¶šã—ã¦ã‚‹ã­');

    // 4. ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆï¼ˆé™å®šæ©Ÿèƒ½ï¼‰
    this.enableOfflineMode();
  }

  attemptReconnection(): void {
    const maxRetries = 3;
    const retryDelay = 2000; // 2ç§’

    // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§å†è©¦è¡Œ
    for (let i = 0; i < maxRetries; i++) {
      setTimeout(() => {
        this.connect();
      }, retryDelay * Math.pow(2, i));
    }
  }
}
```

### 7.3 LLMã‚¨ãƒ©ãƒ¼

```typescript
class LLMErrorHandler {
  handleLLMFailure(context: DialogueContext): FallbackResponse {
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥: å®šå‹è³ªå•ã‚’ä½¿ç”¨
    const fallbackQuestions = [
      'ã“ã®å•é¡Œã€ä½•ã‚’èã„ã¦ã‚‹ã¨æ€ã†ï¼Ÿ',
      'ã‚‚ã†ä¸€å›å•é¡Œèª­ã‚“ã§ã¿ã‚ˆã†ã‹',
      'å‰ã«ä¼¼ãŸã‚ˆã†ãªå•é¡Œã‚„ã£ãŸã‚ˆã­ï¼Ÿ'
    ];

    return {
      useFallback: true,
      question: this.selectFallbackQuestion(context, fallbackQuestions),
      notifyAdmin: true // ç®¡ç†è€…ã«é€šçŸ¥
    };
  }
}
```

---

## 8. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 8.1 èªè¨¼ãƒ»èªå¯

```typescript
// JWT ãƒ™ãƒ¼ã‚¹ã®èªè¨¼
interface AuthToken {
  userId: string;
  role: 'child' | 'parent';
  exp: number;
  iat: number;
}

// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢
const authenticateUser = (req, res, next) => {
  const token = req.headers.authorization?.split(' ')[1];

  try {
    const decoded = verifyJWT(token);
    req.user = decoded;
    next();
  } catch (error) {
    res.status(401).json({ error: 'Unauthorized' });
  }
};
```

### 8.2 ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–

```typescript
class DataEncryption {
  // ä¿å­˜æ™‚ã®æš—å·åŒ–
  encryptSensitiveData(data: UserData): EncryptedData {
    return {
      encryptedData: encrypt(JSON.stringify(data), this.key),
      iv: this.iv,
      algorithm: 'aes-256-gcm'
    };
  }

  // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®ä¸€æ™‚ä¿å­˜
  handleAudioData(audio: ArrayBuffer): void {
    // 1. ä¸€æ™‚ä¿å­˜ï¼ˆå‡¦ç†ã®ãŸã‚ï¼‰
    const tempPath = this.saveTempAudio(audio);

    // 2. å‡¦ç†å®Œäº†å¾Œã«å‰Šé™¤
    this.scheduleCleanup(tempPath, 60000); // 60ç§’å¾Œã«å‰Šé™¤

    // 3. é•·æœŸä¿å­˜ãŒå¿…è¦ãªå ´åˆã¯æš—å·åŒ–
    if (this.needsPersistence) {
      this.encryptAndStore(audio);
    }
  }
}
```

### 8.3 ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ä¿è­·

```typescript
interface PrivacyPolicy {
  // ãƒ‡ãƒ¼ã‚¿ä¿æŒæœŸé–“
  retentionPeriod: {
    audioData: 0,           // å³åº§ã«å‰Šé™¤
    transcripts: 30,        // 30æ—¥é–“
    learningHistory: 365    // 1å¹´é–“
  };

  // ãƒ‡ãƒ¼ã‚¿å…±æœ‰ãƒãƒªã‚·ãƒ¼
  dataSharing: {
    withParents: true,      // ä¿è­·è€…ã¨ã¯å…±æœ‰
    withThirdParty: false,  // ç¬¬ä¸‰è€…ã¨ã¯å…±æœ‰ã—ãªã„
    forResearch: false      // ç ”ç©¶ç›®çš„ã§ã‚‚ä½¿ç”¨ã—ãªã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
  };

  // åŒ¿ååŒ–
  anonymization: {
    enableForAnalytics: true,
    removePersonalInfo: true,
    aggregateOnly: true
  };
}
```

---

## 9. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¦ä»¶

### 9.1 ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ç›®æ¨™

```typescript
interface LatencyTargets {
  stt: {
    target: 200,      // ms
    maximum: 500      // ms
  };

  llm: {
    target: 1000,     // ms
    maximum: 2000     // ms
  };

  tts: {
    target: 300,      // ms
    maximum: 500      // ms
  };

  endToEnd: {
    target: 1500,     // msï¼ˆéŸ³å£°å…¥åŠ›å®Œäº†ã‹ã‚‰å¿œç­”éŸ³å£°é–‹å§‹ã¾ã§ï¼‰
    maximum: 3000     // ms
  };
}
```

### 9.2 æœ€é©åŒ–æˆ¦ç•¥

#### 9.2.1 éŸ³å£°ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°

```typescript
class AudioOptimizer {
  // ãƒãƒ£ãƒ³ã‚¯åŒ–ã—ã¦é€æ¬¡é€ä¿¡
  streamAudio(audioData: ArrayBuffer): void {
    const chunkSize = 4096; // bytes
    const chunks = this.splitIntoChunks(audioData, chunkSize);

    chunks.forEach((chunk, index) => {
      this.sendChunk(chunk, index);
    });
  }

  // éŸ³å£°åœ§ç¸®
  compressAudio(audio: ArrayBuffer): ArrayBuffer {
    return opus.encode(audio, {
      bitrate: 24000,  // 24kbps
      sampleRate: 16000 // 16kHz
    });
  }
}
```

#### 9.2.2 LLM å¿œç­”ã®æœ€é©åŒ–

```typescript
class LLMOptimizer {
  // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
  async generateResponse(prompt: string): AsyncGenerator<string> {
    const stream = await this.llm.streamCompletion(prompt);

    for await (const chunk of stream) {
      yield chunk;
    }
  }

  // ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°
  async getCachedResponse(context: DialogueContext): string | null {
    const cacheKey = this.generateCacheKey(context);
    return await this.cache.get(cacheKey);
  }

  // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆæœ€é©åŒ–
  optimizePrompt(context: DialogueContext): string {
    // ä¸è¦ãªæƒ…å ±ã‚’å‰Šé™¤ã—ã¦ã€ãƒˆãƒ¼ã‚¯ãƒ³æ•°ã‚’å‰Šæ¸›
    return this.minimizePrompt(context);
  }
}
```

#### 9.2.3 TTS äº‹å‰ç”Ÿæˆ

```typescript
class TTSOptimizer {
  // ã‚ˆãä½¿ã†ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’äº‹å‰ç”Ÿæˆ
  preGenerateCommonPhrases(): void {
    const commonPhrases = [
      'ã™ã”ã„ã­ï¼',
      'ã„ã„æ„Ÿã˜ã ã‚ˆ',
      'ã‚‚ã†ä¸€å›è¨€ã£ã¦ãã‚Œã‚‹ï¼Ÿ',
      'ã‚†ã£ãã‚Šè€ƒãˆã¦ã¿ã‚ˆã†'
    ];

    commonPhrases.forEach(async (phrase) => {
      const audio = await this.tts.synthesize(phrase);
      await this.cache.set(`tts:${phrase}`, audio);
    });
  }
}
```

---

## 10. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 10.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

```typescript
// å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ†ã‚¹ãƒˆ
describe('SocraticDialogueManager', () => {
  it('should generate understanding check question', () => {
    const manager = new SocraticDialogueManager();
    const problem = createMockProblem();

    const question = manager.generateQuestion({
      problem,
      questionType: 'understanding_check'
    });

    expect(question).toContain('ä½•ã‚’èã„ã¦ã‚‹');
  });

  it('should adapt to frustration', () => {
    const manager = new SocraticDialogueManager();
    const context = {
      emotionalState: EmotionalState.FRUSTRATED,
      attemptsCount: 5
    };

    const adaptation = manager.adapt(context);

    expect(adaptation.hintLevel).toBe(3);
    expect(adaptation.action).toBe('simplify');
  });
});
```

### 10.2 çµ±åˆãƒ†ã‚¹ãƒˆ

```typescript
// éŸ³å£°ãƒ•ãƒ­ãƒ¼å…¨ä½“ã®ãƒ†ã‚¹ãƒˆ
describe('Voice Dialogue Flow', () => {
  it('should handle complete dialogue session', async () => {
    const session = await createTestSession();

    // 1. éŸ³å£°å…¥åŠ›
    await session.sendAudio(mockAudioData);

    // 2. æ–‡å­—èµ·ã“ã—ç¢ºèª
    const transcript = await session.waitForTranscript();
    expect(transcript).toBeDefined();

    // 3. å¿œç­”ç”Ÿæˆç¢ºèª
    const response = await session.waitForResponse();
    expect(response.audioUrl).toBeDefined();

    // 4. ã‚»ãƒƒã‚·ãƒ§ãƒ³çŠ¶æ…‹ç¢ºèª
    expect(session.state.dialogueHistory.length).toBeGreaterThan(0);
  });
});
```

### 10.3 E2Eãƒ†ã‚¹ãƒˆ

```typescript
// Playwright ã‚’ä½¿ã£ãŸ E2E ãƒ†ã‚¹ãƒˆ
describe('User Journey', () => {
  it('should complete a problem with hints', async ({ page }) => {
    // 1. ãƒ­ã‚°ã‚¤ãƒ³
    await page.goto('/login');
    await loginAsChild(page);

    // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹
    await page.click('[data-testid="start-session"]');

    // 3. ãƒã‚¤ã‚¯æ¨©é™è¨±å¯
    await page.context().grantPermissions(['microphone']);

    // 4. å•é¡Œèª­ã¿ä¸Šã’ï¼ˆãƒ¢ãƒƒã‚¯éŸ³å£°ï¼‰
    await sendMockAudio(page, 'problem_audio.wav');

    // 5. ã‚³ãƒ¼ãƒã®è³ªå•ã‚’å¾…ã¤
    await page.waitForSelector('[data-testid="coach-speaking"]');

    // 6. ãƒ’ãƒ³ãƒˆè¦æ±‚
    await page.click('[data-testid="hint-button"]');

    // 7. ãƒ’ãƒ³ãƒˆè¡¨ç¤ºç¢ºèª
    await expect(page.locator('[data-testid="hint-box"]')).toBeVisible();

    // 8. æ­£è§£
    await sendMockAudio(page, 'correct_answer.wav');

    // 9. ãƒã‚¤ãƒ³ãƒˆç²å¾—ç¢ºèª
    await expect(page.locator('[data-testid="points-earned"]')).toContainText('2');
  });
});
```

---

## 11. ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ»åˆ†æ

### 11.1 ãƒ¡ãƒˆãƒªã‚¯ã‚¹

```typescript
interface Metrics {
  // ã‚·ã‚¹ãƒ†ãƒ ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  system: {
    sttLatency: number[];
    llmLatency: number[];
    ttsLatency: number[];
    endToEndLatency: number[];
    errorRate: number;
    activeConnections: number;
  };

  // ãƒ“ã‚¸ãƒã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
  business: {
    dailyActiveUsers: number;
    averageSessionDuration: number;
    problemsSolvedPerSession: number;
    hintUsageRate: number;
    selfDiscoveryRate: number;
  };

  // å­¦ç¿’åŠ¹æœãƒ¡ãƒˆãƒªã‚¯ã‚¹
  learning: {
    averageAttemptsPerProblem: number;
    improvementRate: number;
    conceptMasteryProgression: Map<string, number>;
  };
}
```

### 11.2 ãƒ­ã‚°è¨­è¨ˆ

```typescript
interface LogEntry {
  timestamp: Date;
  level: 'info' | 'warn' | 'error';
  category: 'system' | 'dialogue' | 'learning';
  message: string;
  metadata: Record<string, any>;
}

// å¯¾è©±ãƒ­ã‚°
const dialogueLog: LogEntry = {
  timestamp: new Date(),
  level: 'info',
  category: 'dialogue',
  message: 'Question generated',
  metadata: {
    sessionId: 'xxx',
    questionType: 'understanding_check',
    emotionalState: 'neutral',
    latency: 1234
  }
};

// ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°
const errorLog: LogEntry = {
  timestamp: new Date(),
  level: 'error',
  category: 'system',
  message: 'STT service timeout',
  metadata: {
    sessionId: 'xxx',
    errorCode: 'STT_TIMEOUT',
    retryCount: 2
  }
};
```

---

## 12. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆï¼ˆGoogle Cloud Platformï¼‰

### 12.1 ç’°å¢ƒæ§‹æˆ

#### é–‹ç™ºç’°å¢ƒ
```bash
# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
ENVIRONMENT=development
FRONTEND_URL=http://localhost:3000
BACKEND_URL=http://localhost:8000
NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
NEXT_PUBLIC_WS_URL=ws://localhost:8000

# Google Cloudè¨­å®š
GOOGLE_CLOUD_PROJECT=homework-coach-dev
GOOGLE_CLOUD_LOCATION=asia-northeast1
GOOGLE_GENAI_USE_VERTEXAI=TRUE

# Firestore Emulator
FIRESTORE_EMULATOR_HOST=localhost:8080

# BigQueryï¼ˆé–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆï¼‰
BIGQUERY_DATASET=homework_coach_dev
```

#### ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
```bash
# Cloud Run
FRONTEND_URL=https://frontend-staging-xxxxx-an.a.run.app
BACKEND_URL=https://api-staging-xxxxx-an.a.run.app
NEXT_PUBLIC_BACKEND_URL=https://api-staging-xxxxx-an.a.run.app
NEXT_PUBLIC_WS_URL=wss://api-staging-xxxxx-an.a.run.app

# Google Cloudè¨­å®š
GOOGLE_CLOUD_PROJECT=homework-coach-staging
GOOGLE_CLOUD_LOCATION=asia-northeast1
GOOGLE_GENAI_USE_VERTEXAI=TRUE

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
FIRESTORE_DATABASE=(default)
BIGQUERY_DATASET=homework_coach_staging
REDIS_HOST=10.x.x.x  # Memorystore Redis IP
REDIS_PORT=6379

# ADK/Geminiè¨­å®š
DEMO_AGENT_MODEL=gemini-2.5-flash-native-audio-preview
```

#### æœ¬ç•ªç’°å¢ƒ
```bash
# Cloud Run
FRONTEND_URL=https://frontend-xxxxx-an.a.run.app  # ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: homeworkcoach.com
BACKEND_URL=https://api-xxxxx-an.a.run.app  # ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³: api.homeworkcoach.com
NEXT_PUBLIC_BACKEND_URL=https://api.homeworkcoach.com
NEXT_PUBLIC_WS_URL=wss://api.homeworkcoach.com

# Google Cloudè¨­å®š
GOOGLE_CLOUD_PROJECT=homework-coach-prod
GOOGLE_CLOUD_LOCATION=asia-northeast1
GOOGLE_GENAI_USE_VERTEXAI=TRUE

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
FIRESTORE_DATABASE=(default)
BIGQUERY_DATASET=homework_coach_prod
REDIS_HOST=10.x.x.x
REDIS_PORT=6379

# ADK/Geminiè¨­å®š
DEMO_AGENT_MODEL=gemini-2.5-flash-native-audio
```

### 12.2 Google Cloud ãƒªã‚½ãƒ¼ã‚¹è¨­å®š

#### 12.2.1 BigQueryãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ

```bash
# ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆä½œæˆ
bq mk --dataset \
  --location=asia-northeast1 \
  --description="å®¿é¡Œã‚³ãƒ¼ãƒãƒ­ãƒœãƒƒãƒˆå­¦ç¿’ãƒ‡ãƒ¼ã‚¿" \
  homework-coach-prod:homework_coach_prod

# ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
bq mk --table \
  homework_coach_prod.dialogue_sessions \
  schema/dialogue_sessions.json

bq mk --table \
  homework_coach_prod.problem_attempts \
  schema/problem_attempts.json

bq mk --table \
  homework_coach_prod.dialogue_turns \
  schema/dialogue_turns.json
```

**schema/dialogue_sessions.json**
```json
[
  {"name": "session_id", "type": "STRING", "mode": "REQUIRED"},
  {"name": "user_id", "type": "STRING", "mode": "REQUIRED"},
  {"name": "start_time", "type": "TIMESTAMP", "mode": "REQUIRED"},
  {"name": "end_time", "type": "TIMESTAMP", "mode": "NULLABLE"},
  {"name": "total_points", "type": "INT64", "mode": "NULLABLE"},
  {"name": "problems_attempted", "type": "JSON", "mode": "NULLABLE"},
  {"name": "dialogue_turns", "type": "JSON", "mode": "NULLABLE"},
  {"name": "created_at", "type": "TIMESTAMP", "mode": "REQUIRED"}
]
```

#### 12.2.2 Firestoreè¨­å®š

```bash
# Firestoreãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä½œæˆï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰
gcloud firestore databases create \
  --location=asia-northeast1 \
  --type=firestore-native

# ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
gcloud firestore indexes composite create \
  --collection-group=sessions \
  --query-scope=COLLECTION \
  --field-config field-path=userId,order=ASCENDING \
  --field-config field-path=createdAt,order=DESCENDING
```

#### 12.2.3 Cloud Memorystore for Redis

```bash
# Redis ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
gcloud redis instances create homework-coach-cache \
  --size=1 \
  --region=asia-northeast1 \
  --zone=asia-northeast1-a \
  --tier=basic \
  --redis-version=redis_7_0
```

#### 12.2.4 Secret Managerè¨­å®š

```bash
# ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆ
echo -n "gemini-2.5-flash-native-audio" | \
  gcloud secrets create agent-model --data-file=-

echo -n "your-api-key" | \
  gcloud secrets create gemini-api-key --data-file=-

# Cloud Runã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ä»˜ä¸
gcloud secrets add-iam-policy-binding agent-model \
  --member="serviceAccount:homework-coach@homework-coach-prod.iam.gserviceaccount.com" \
  --role="roles/secretmanager.secretAccessor"
```

### 12.3 Dockerfileã¨ãƒ“ãƒ«ãƒ‰

#### backend/Dockerfile
```dockerfile
FROM python:3.11-slim

WORKDIR /app

# ã‚·ã‚¹ãƒ†ãƒ ä¾å­˜é–¢ä¿‚ + uvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    curl \
    gcc \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && rm -rf /var/lib/apt/lists/*

# uvã‚’PATHã«è¿½åŠ 
ENV PATH="/root/.cargo/bin:$PATH"

# Pythonä¾å­˜é–¢ä¿‚ï¼ˆuvã§é«˜é€Ÿã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼‰
COPY requirements.txt .
RUN uv pip install --system --no-cache -r requirements.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
COPY ./app /app

# Cloud Runã®ãƒãƒ¼ãƒˆï¼ˆç’°å¢ƒå¤‰æ•°PORTã‹ã‚‰å–å¾—ï¼‰
ENV PORT=8080
EXPOSE 8080

# Uvicornã§ã‚¢ãƒ—ãƒªèµ·å‹•
CMD exec uvicorn main:app --host 0.0.0.0 --port ${PORT}
```

**uvã‚’ä½¿ã£ãŸåˆ©ç‚¹:**
- ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚é–“ãŒå¤§å¹…çŸ­ç¸®ï¼ˆpipæ¯”10-100å€é«˜é€Ÿï¼‰
- Dockerãƒ“ãƒ«ãƒ‰æ™‚é–“ã®çŸ­ç¸®
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®å‰Šæ¸›

#### requirements.txt
```txt
google-adk>=1.20.0
fastapi>=0.115.0
uvicorn[standard]>=0.32.0
python-dotenv>=1.0.0
google-cloud-firestore>=2.11.0
google-cloud-bigquery>=3.10.0
google-cloud-speech>=2.20.0
google-cloud-texttospeech>=2.14.0
google-cloud-secret-manager>=2.16.0
redis>=5.0.0
```

#### frontend/Dockerfile
```dockerfile
# ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã‚’æœ€é©åŒ–
FROM oven/bun:1 AS builder

WORKDIR /app

# ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰ã®ã‚³ãƒ”ãƒ¼
COPY . .

# Next.jsãƒ“ãƒ«ãƒ‰
RUN bun run build

# æœ¬ç•ªç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸
FROM oven/bun:1-alpine AS runner

WORKDIR /app

# æœ¬ç•ªç’°å¢ƒè¨­å®š
ENV NODE_ENV=production
ENV PORT=8080

# å¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚³ãƒ”ãƒ¼
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# érootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å®Ÿè¡Œ
RUN addgroup --system --gid 1001 bunjs
RUN adduser --system --uid 1001 nextjs -G bunjs
USER nextjs

EXPOSE 8080

# Next.jsã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆBunã§å®Ÿè¡Œï¼‰
CMD ["bun", "run", "server.js"]
```

**Bun Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®åˆ©ç‚¹:**
- ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºãŒå°ã•ã„ï¼ˆAlpine: ~50MBï¼‰
- èµ·å‹•ãŒé«˜é€Ÿï¼ˆNode.jsã‚ˆã‚Š2-3å€é€Ÿã„ï¼‰
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå°‘ãªã„

#### next.config.js
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // Cloud Runç”¨ã®æœ€é©åŒ–
  output: 'standalone',

  // ç’°å¢ƒå¤‰æ•°
  env: {
    NEXT_PUBLIC_BACKEND_URL: process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000',
    NEXT_PUBLIC_WS_URL: process.env.NEXT_PUBLIC_WS_URL || 'ws://localhost:8000',
  },

  // ç”»åƒæœ€é©åŒ–ï¼ˆCloud Storageã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼‰
  images: {
    loader: 'custom',
    loaderFile: './lib/cloudStorageImageLoader.js',
  },

  // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          {
            key: 'X-DNS-Prefetch-Control',
            value: 'on'
          },
          {
            key: 'X-Frame-Options',
            value: 'SAMEORIGIN'
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff'
          },
        ],
      },
    ];
  },

  // WebSocketãƒ—ãƒ­ã‚­ã‚·ï¼ˆé–‹ç™ºç’°å¢ƒã®ã¿ï¼‰
  async rewrites() {
    if (process.env.NODE_ENV === 'development') {
      return [
        {
          source: '/ws/:path*',
          destination: 'ws://localhost:8000/ws/:path*',
        },
      ];
    }
    return [];
  },
};

module.exports = nextConfig;
```

#### package.json
```json
{
  "name": "homework-coach-frontend",
  "version": "1.0.0",
  "private": true,
  "scripts": {
    "dev": "bun run next dev",
    "build": "bun run next build",
    "start": "bun run next start -p ${PORT:-8080}",
    "lint": "bun run next lint",
    "test": "bun test"
  },
  "dependencies": {
    "next": "^14.1.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "jotai": "^2.6.0",
    "@rive-app/react-canvas": "^4.7.0",
    "@rive-app/react-webgl": "^4.7.0"
  },
  "devDependencies": {
    "@types/bun": "^1.0.0",
    "@types/react": "^18.2.48",
    "@types/react-dom": "^18.2.18",
    "typescript": "^5.3.3",
    "eslint": "^8.56.0",
    "eslint-config-next": "^14.1.0"
  }
}
```

**æ³¨:** Bunã¯`bun.lockb`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã™ï¼ˆpackage-lock.jsonã®ä»£ã‚ã‚Šï¼‰

### 12.4 CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆCloud Build + GitHub Actionsï¼‰

#### .github/workflows/deploy-frontend.yml
```yaml
name: Deploy Frontend to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'

env:
  PROJECT_ID: homework-coach-prod
  REGION: asia-northeast1
  SERVICE_NAME: homework-coach-frontend

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          docker build -t asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/frontend:${{ github.sha }} ./frontend
          docker push asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/frontend:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/frontend:${{ github.sha }} \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --set-env-vars="NEXT_PUBLIC_BACKEND_URL=https://api-xxxxx-an.a.run.app,NEXT_PUBLIC_WS_URL=wss://api-xxxxx-an.a.run.app" \
            --min-instances=0 \
            --max-instances=10 \
            --memory=512Mi \
            --cpu=1 \
            --timeout=60
```

#### .github/workflows/deploy-backend.yml
```yaml
name: Deploy Backend to Cloud Run

on:
  push:
    branches: [main]
    paths:
      - 'backend/**'

env:
  PROJECT_ID: homework-coach-prod
  REGION: asia-northeast1
  SERVICE_NAME: homework-coach-api

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1

      - name: Configure Docker for Artifact Registry
        run: |
          gcloud auth configure-docker asia-northeast1-docker.pkg.dev

      - name: Build and Push Docker image
        run: |
          docker build -t asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:${{ github.sha }} ./backend
          docker push asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:${{ github.sha }}

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy $SERVICE_NAME \
            --image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:${{ github.sha }} \
            --platform=managed \
            --region=$REGION \
            --allow-unauthenticated \
            --set-env-vars="GOOGLE_CLOUD_PROJECT=$PROJECT_ID,GOOGLE_CLOUD_LOCATION=$REGION,GOOGLE_GENAI_USE_VERTEXAI=TRUE" \
            --set-secrets="DEMO_AGENT_MODEL=agent-model:latest" \
            --min-instances=1 \
            --max-instances=10 \
            --memory=2Gi \
            --cpu=2 \
            --timeout=300
```

#### cloudbuild.yamlï¼ˆCloud Buildç”¨ï¼‰
```yaml
steps:
  # Run tests
  - name: python:3.11
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        cd backend
        pip install -r requirements.txt
        pytest tests/

  # Build Docker image
  - name: gcr.io/cloud-builders/docker
    args:
      - build
      - -t
      - asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:$SHORT_SHA
      - -t
      - asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:latest
      - ./backend

  # Push to Artifact Registry
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - --all-tags
      - asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api

  # Deploy to Cloud Run
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: gcloud
    args:
      - run
      - deploy
      - homework-coach-api
      - --image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:$SHORT_SHA
      - --region=asia-northeast1
      - --platform=managed
      - --allow-unauthenticated
      - --set-env-vars=GOOGLE_CLOUD_PROJECT=$PROJECT_ID,GOOGLE_CLOUD_LOCATION=asia-northeast1

images:
  - asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:$SHORT_SHA
  - asia-northeast1-docker.pkg.dev/$PROJECT_ID/homework-coach/api:latest

options:
  logging: CLOUD_LOGGING_ONLY
```

### 12.5 ç’°å¢ƒå¤‰æ•°ç®¡ç†

#### .env.template
```bash
# Google Cloudè¨­å®š
GOOGLE_CLOUD_PROJECT=your-project-id
GOOGLE_CLOUD_LOCATION=asia-northeast1
GOOGLE_GENAI_USE_VERTEXAI=TRUE

# ADK/Geminiè¨­å®š
DEMO_AGENT_MODEL=gemini-2.5-flash-native-audio-preview

# BigQuery
BIGQUERY_DATASET=homework_coach_dev

# Redisï¼ˆMemorystoreï¼‰
REDIS_HOST=localhost
REDIS_PORT=6379

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
PORT=8080
ENVIRONMENT=development

# Next.jsè¨­å®šï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼‰
NEXT_PUBLIC_BACKEND_URL=http://localhost:8000
NEXT_PUBLIC_WS_URL=ws://localhost:8000
```

### 12.6 ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã¨CDNè¨­å®š

#### ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³ã®è¨­å®š

```bash
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³
gcloud run domain-mappings create \
  --service=homework-coach-frontend \
  --domain=homeworkcoach.com \
  --region=asia-northeast1

# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ç”¨ã‚«ã‚¹ã‚¿ãƒ ãƒ‰ãƒ¡ã‚¤ãƒ³
gcloud run domain-mappings create \
  --service=homework-coach-api \
  --domain=api.homeworkcoach.com \
  --region=asia-northeast1

# DNSãƒ¬ã‚³ãƒ¼ãƒ‰ã®è¨­å®šï¼ˆCloud DNSã¾ãŸã¯å¤–éƒ¨DNSï¼‰
# CNAME: homeworkcoach.com â†’ ghs.googlehosted.com
# CNAME: api.homeworkcoach.com â†’ ghs.googlehosted.com
```

#### Cloud Load Balancer + Cloud CDNï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ã‚°ãƒ­ãƒ¼ãƒãƒ«é…ä¿¡ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ€é©åŒ–ã™ã‚‹å ´åˆï¼š

```bash
# 1. ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆNEGï¼‰ä½œæˆ
gcloud compute network-endpoint-groups create homework-coach-frontend-neg \
  --region=asia-northeast1 \
  --network-endpoint-type=serverless \
  --cloud-run-service=homework-coach-frontend

# 2. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ä½œæˆ
gcloud compute backend-services create homework-coach-frontend-backend \
  --global \
  --enable-cdn \
  --cache-mode=CACHE_ALL_STATIC

# 3. NEGã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«è¿½åŠ 
gcloud compute backend-services add-backend homework-coach-frontend-backend \
  --global \
  --network-endpoint-group=homework-coach-frontend-neg \
  --network-endpoint-group-region=asia-northeast1

# 4. URL ãƒãƒƒãƒ—ä½œæˆ
gcloud compute url-maps create homework-coach-lb \
  --default-service=homework-coach-frontend-backend

# 5. HTTPSãƒ—ãƒ­ã‚­ã‚·ä½œæˆï¼ˆSSLè¨¼æ˜æ›¸ã¯äº‹å‰ä½œæˆãŒå¿…è¦ï¼‰
gcloud compute target-https-proxies create homework-coach-https-proxy \
  --url-map=homework-coach-lb \
  --ssl-certificates=homework-coach-ssl-cert

# 6. ã‚°ãƒ­ãƒ¼ãƒãƒ«IPã‚¢ãƒ‰ãƒ¬ã‚¹ç¢ºä¿
gcloud compute addresses create homework-coach-ip \
  --global \
  --ip-version=IPV4

# 7. è»¢é€ãƒ«ãƒ¼ãƒ«ä½œæˆ
gcloud compute forwarding-rules create homework-coach-https-rule \
  --global \
  --target-https-proxy=homework-coach-https-proxy \
  --address=homework-coach-ip \
  --ports=443
```

**Cloud CDNã®ãƒ¡ãƒªãƒƒãƒˆ:**
- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·å‰Šæ¸›ï¼ˆä¸–ç•Œä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾å¿œï¼‰
- Cloud Runã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°å‰Šæ¸›ï¼ˆã‚³ã‚¹ãƒˆå‰Šæ¸›ï¼‰

**ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®šä¾‹:**
```bash
# é™çš„ã‚¢ã‚»ãƒƒãƒˆã¯é•·æœŸã‚­ãƒ£ãƒƒã‚·ãƒ¥
gcloud compute backend-services update homework-coach-frontend-backend \
  --global \
  --cache-mode=CACHE_ALL_STATIC \
  --default-ttl=3600 \
  --max-ttl=86400 \
  --client-ttl=3600
```

### 12.7 é™çš„ã‚¢ã‚»ãƒƒãƒˆã®æœ€é©åŒ–ï¼ˆæ¨å¥¨ï¼‰

**Cloud Storageã‹ã‚‰ã®é…ä¿¡:**

```bash
# 1. ãƒã‚±ãƒƒãƒˆä½œæˆ
gsutil mb -l asia-northeast1 gs://homework-coach-assets

# 2. å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š
gsutil iam ch allUsers:objectViewer gs://homework-coach-assets

# 3. ç”»åƒãƒ»CSSãƒ»JSã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
gsutil -m cp -r frontend/public/* gs://homework-coach-assets/

# 4. Cloud CDNã¨çµ±åˆ
gcloud compute backend-buckets create homework-coach-assets-backend \
  --gcs-bucket-name=homework-coach-assets \
  --enable-cdn
```

**Next.jsè¨­å®š:**
```javascript
// next.config.js
module.exports = {
  assetPrefix: process.env.NODE_ENV === 'production'
    ? 'https://assets.homeworkcoach.com'
    : '',
  // ...
};
```

### 12.8 ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆå¯¾ç­–ï¼ˆæœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹0ã®å ´åˆï¼‰

#### ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã¨ã¯

æœ€å°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹0ã®å ´åˆã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãªã„çŠ¶æ…‹ãŒç¶šãã¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒåœæ­¢ã—ã€æ¬¡å›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ãŒå¿…è¦ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šåˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«0.5ã€œ3ç§’ã®é…å»¶ãŒç™ºç”Ÿã—ã¾ã™ã€‚

#### ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã®è¨±å®¹åˆ¤æ–­

**è¨±å®¹ã§ãã‚‹ã‚±ãƒ¼ã‚¹ï¼ˆæœ¬ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰:**
- âœ… å­¦ç¿’ç›®çš„ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- âœ… å†…éƒ¨ãƒ„ãƒ¼ãƒ«ãƒ»ç®¡ç†ç”»é¢
- âœ… B2B SaaSã®ç®¡ç†ç”»é¢
- âœ… ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ãŒå°‘ãªã„åˆæœŸæ®µéš

**è¨±å®¹ã§ããªã„ã‚±ãƒ¼ã‚¹:**
- âŒ é«˜é »åº¦ã‚¢ã‚¯ã‚»ã‚¹ã®ã‚ã‚‹Cå‘ã‘ã‚µãƒ¼ãƒ“ã‚¹
- âŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ€§ãŒé‡è¦ãªã‚¢ãƒ—ãƒª
- âŒ SLAä¿è¨¼ãŒå¿…è¦ãªã‚µãƒ¼ãƒ“ã‚¹

#### å¯¾ç­–1: Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®æœ€é©åŒ–

**ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã§ã‚µã‚¤ã‚ºå‰Šæ¸›:**

```dockerfile
# ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.js + Bunï¼‰
FROM oven/bun:1 AS builder
WORKDIR /app
COPY package.json bun.lockb ./
RUN bun install --frozen-lockfile --production
COPY . .
RUN bun run build

FROM oven/bun:1-alpine AS runner
WORKDIR /app
ENV NODE_ENV=production
COPY --from=builder /app/public ./public
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static

# ç›®æ¨™: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º < 80MBï¼ˆBunã®æ–¹ãŒå°ã•ã„ï¼‰
```

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆFastAPI + uvï¼‰:**

```dockerfile
FROM python:3.11-slim
WORKDIR /app

# uvã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl \
    gcc \
    && curl -LsSf https://astral.sh/uv/install.sh | sh \
    && rm -rf /var/lib/apt/lists/*

# uvã‚’PATHã«è¿½åŠ 
ENV PATH="/root/.cargo/bin:$PATH"

# ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆuvã§é«˜é€ŸåŒ–ï¼‰
COPY requirements.txt .
RUN uv pip install --system -r requirements.txt

# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ¼ãƒ‰
COPY . .

# è»½é‡ãªPythonã‚¤ãƒ¡ãƒ¼ã‚¸ + uvä½¿ç”¨
# ç›®æ¨™: ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º < 500MBã€ãƒ“ãƒ«ãƒ‰æ™‚é–“50%å‰Šæ¸›
```

#### å¯¾ç­–2: èµ·å‹•æ™‚é–“ã®æœ€é©åŒ–

**Next.jsè¨­å®š:**

```javascript
// next.config.js
module.exports = {
  experimental: {
    // Next.js 14ä»¥é™ã®é«˜é€ŸåŒ–æ©Ÿèƒ½
    optimizePackageImports: ['@mui/material', 'framer-motion'],
  },
  compiler: {
    // ä¸è¦ãªæ©Ÿèƒ½ã‚’å‰Šé™¤
    removeConsole: process.env.NODE_ENV === 'production',
  },
};
```

**FastAPIè¨­å®š:**

```python
# main.py
from fastapi import FastAPI

# èµ·å‹•æ™‚ã®é…å»¶ã‚’å‰Šæ¸›
app = FastAPI(
    # OpenAPI docsã‚’ç„¡åŠ¹åŒ–ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
    docs_url=None if os.getenv("ENVIRONMENT") == "production" else "/docs",
    redoc_url=None if os.getenv("ENVIRONMENT") == "production" else "/redoc",
)

# èµ·å‹•æ™‚ã®åˆæœŸåŒ–ã‚’æœ€å°é™ã«
@app.on_event("startup")
async def startup_event():
    # å¿…è¦æœ€å°é™ã®åˆæœŸåŒ–ã®ã¿
    pass
```

#### å¯¾ç­–3: Cloud Scheduler ã«ã‚ˆã‚‹ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—

å®šæœŸçš„ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ã‚¦ã‚©ãƒ¼ãƒ ã«ä¿ã¤ï¼š

```bash
# Cloud Scheduler ã‚¸ãƒ§ãƒ–ä½œæˆ
gcloud scheduler jobs create http keep-warm-frontend \
  --schedule="*/5 * * * *" \
  --uri="https://frontend-xxxxx-an.a.run.app/health" \
  --http-method=GET \
  --location=asia-northeast1

gcloud scheduler jobs create http keep-warm-backend \
  --schedule="*/5 * * * *" \
  --uri="https://api-xxxxx-an.a.run.app/health" \
  --http-method=GET \
  --location=asia-northeast1
```

**ã‚³ã‚¹ãƒˆ:**
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°: 288å›/æ—¥ Ã— 30æ—¥ = 8,640å›/æœˆ
- ç„¡æ–™æ ï¼ˆ200ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰å†…ã«åã¾ã‚‹
- **è¿½åŠ ã‚³ã‚¹ãƒˆ: $0**

**æ³¨æ„ç‚¹:**
- ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—é–“éš”ã¯5åˆ†æ¨å¥¨ï¼ˆé•·ã™ãã‚‹ã¨ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆç™ºç”Ÿï¼‰
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯è»½é‡ã«å®Ÿè£…

#### å¯¾ç­–4: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®å®Ÿè£…

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.jsï¼‰:**

```typescript
// app/api/health/route.ts
export async function GET() {
  return new Response(JSON.stringify({ status: 'ok' }), {
    status: 200,
    headers: {
      'Content-Type': 'application/json',
      'Cache-Control': 'no-cache',
    },
  });
}
```

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆFastAPIï¼‰:**

```python
# main.py
@app.get("/health")
async def health_check():
    """è»½é‡ãªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯"""
    return {"status": "ok"}
```

#### å¯¾ç­–5: CPU Boost ã®æœ‰åŠ¹åŒ–

Cloud Run ã® CPU Boost æ©Ÿèƒ½ã§èµ·å‹•æ™‚é–“ã‚’çŸ­ç¸®ï¼š

```bash
gcloud run services update homework-coach-frontend \
  --region=asia-northeast1 \
  --cpu-boost

# èµ·å‹•æ™‚ã«ä¸€æ™‚çš„ã«è¿½åŠ CPUã‚’å‰²ã‚Šå½“ã¦
# ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆæ™‚é–“ãŒ30-50%çŸ­ç¸®
```

**ã‚³ã‚¹ãƒˆ:**
- è¿½åŠ æ–™é‡‘: ã‚ãšã‹ï¼ˆèµ·å‹•æ™‚ã®ã¿ã®çŸ­æ™‚é–“ï¼‰
- åŠ¹æœ: èµ·å‹•æ™‚é–“ãŒ1ã€œ2ç§’çŸ­ç¸®

#### å¯¾ç­–6: Cloud Run ã®èµ·å‹•æ™‚é–“ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

```bash
# Cloud Logging ã§ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚’ç›£è¦–
gcloud logging read "resource.type=cloud_run_revision
  AND jsonPayload.message=~\"Cold start\"" \
  --limit=50 \
  --format=json
```

**Monitoring ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰:**
- ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆç™ºç”Ÿå›æ•°
- å¹³å‡èµ·å‹•æ™‚é–“
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¿œç­”æ™‚é–“

#### å®Ÿéš›ã®èµ·å‹•æ™‚é–“ç›®å®‰

**æœ€é©åŒ–å‰:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 2ã€œ3ç§’
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 3ã€œ5ç§’

**æœ€é©åŒ–å¾Œ:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰: 0.5ã€œ1.5ç§’
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰: 1ã€œ2ç§’

#### ç’°å¢ƒåˆ¥ã®æ¨å¥¨è¨­å®š

```yaml
# é–‹ç™ºç’°å¢ƒ
frontend:
  min-instances: 0  # ã‚³ã‚¹ãƒˆå„ªå…ˆ
  cpu-boost: false
  scheduler: ãªã—

backend:
  min-instances: 0  # ã‚³ã‚¹ãƒˆå„ªå…ˆ
  cpu-boost: false
  scheduler: ãªã—

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
frontend:
  min-instances: 0
  cpu-boost: true   # ãƒ†ã‚¹ãƒˆæ™‚ã¯é«˜é€ŸåŒ–
  scheduler: ã‚ã‚Šï¼ˆ5åˆ†é–“éš”ï¼‰

backend:
  min-instances: 0
  cpu-boost: true
  scheduler: ã‚ã‚Šï¼ˆ5åˆ†é–“éš”ï¼‰

# æœ¬ç•ªç’°å¢ƒï¼ˆé¸æŠè‚¢ï¼‰
## ã‚ªãƒ—ã‚·ãƒ§ãƒ³A: ã‚³ã‚¹ãƒˆå„ªå…ˆ
frontend:
  min-instances: 0
  cpu-boost: true
  scheduler: ã‚ã‚Šï¼ˆ5åˆ†é–“éš”ï¼‰

backend:
  min-instances: 1  # WebSocketç¶­æŒã®ãŸã‚å¸¸æ™‚èµ·å‹•

## ã‚ªãƒ—ã‚·ãƒ§ãƒ³B: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å„ªå…ˆ
frontend:
  min-instances: 1  # ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆãªã—
  cpu-boost: false  # ä¸è¦

backend:
  min-instances: 1
  cpu-boost: false
```

#### ã‚³ã‚¹ãƒˆæ¯”è¼ƒï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰

| æ§‹æˆ | ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | åˆè¨ˆ/æœˆ |
|------|--------------|-------------|---------|
| **æœ€å°0+Scheduler** | $0.50 | $60 | **$60.50** |
| **æœ€å°1** | $60 | $60 | **$120** |

**æ¨å¥¨: æœ€å°0+Scheduler**
- ã‚³ã‚¹ãƒˆãŒåŠåˆ†
- Schedulerã§å®Ÿè³ªçš„ã«ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚’å›é¿
- è¿½åŠ ã‚³ã‚¹ãƒˆã¯$0

---

## 13. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### 13.1 æŠ€è¡“æ¤œè¨¼ï¼ˆPoCï¼‰

1. **éŸ³å£°èªè­˜ç²¾åº¦ã®æ¤œè¨¼**
   - ä½å­¦å¹´å…ç«¥ã®éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã§ STT ç²¾åº¦ã‚’ãƒ†ã‚¹ãƒˆ
   - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒã‚¤ã‚ºè€æ€§ã®ç¢ºèª

2. **å¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—**
   - LLM ã‚’ä½¿ã£ãŸã‚½ã‚¯ãƒ©ãƒ†ã‚¹å¼è³ªå•ç”Ÿæˆ
   - ãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®å®Ÿè£…

3. **ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·æ¸¬å®š**
   - STT â†’ LLM â†’ TTS ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ™‚é–“æ¸¬å®š
   - ç›®æ¨™å€¤ï¼ˆ< 3ç§’ï¼‰ã®é”æˆå¯èƒ½æ€§ç¢ºèª

### 13.2 MVPé–‹ç™ºãƒ•ã‚§ãƒ¼ã‚º

**ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆ1-2ãƒ¶æœˆï¼‰**: ã‚³ã‚¢æ©Ÿèƒ½
- éŸ³å£°ã‚¤ãƒ³ã‚¿ãƒ•ã‚§ãƒ¼ã‚¹
- åŸºæœ¬çš„ãªå¯¾è©±ã‚¨ãƒ³ã‚¸ãƒ³
- 3æ®µéšãƒ’ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ 

**ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆ2-3ãƒ¶æœˆï¼‰**: æ‹¡å¼µæ©Ÿèƒ½
- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚·ã‚¹ãƒ†ãƒ 
- é€²æ—ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- ä¿è­·è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç°¡æ˜“ç‰ˆï¼‰

**ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆ3-4ãƒ¶æœˆï¼‰**: é«˜åº¦ãªæ©Ÿèƒ½
- æ„Ÿæƒ…èªè­˜
- ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
- é©å¿œçš„å­¦ç¿’

---

**æ–‡æ›¸ä½œæˆæ—¥**: 2026-01-28
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.6
**ä½œæˆè€…**: Claude Code
**ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹**: Draft
**æœ€çµ‚æ›´æ–°**: æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯æ›´æ–°ï¼ˆBun, Jotai, uvæ¡ç”¨ï¼‰ã€Dockerfileæœ€é©åŒ–ï¼ˆ2026-01-29ï¼‰

